# çº¿æ®µæ ‘ä»å…¥é—¨åˆ°æ€¥åœ

âš ï¸ âš ï¸ âš ï¸ **è°¨ä»¥æ­¤ä¸¤ä¸‡äº”åƒå­—æ–‡ç« çŒ®ç»™åœ¨çº¿æ®µæ ‘é—¨å‰å¾˜å¾Šçš„æœ‹å‹ã€‚**

â—ï¸ **ã€NEWã€‘æœ€æ–°æ–‡ç« å¦‚ä¸‹** â—ï¸

- 9-15:  [çº¢é»‘æ ‘ä»å…¥é—¨åˆ°çœ‹å¼€](https://leetcode.cn/circle/discuss/SwgIJV/)

è¿™æ˜¯å°ç™½ yuki æ¨å‡ºçš„ã€Œæ ‘ADTã€ç³»åˆ—æ–‡ç« çš„ç¬¬ 11 ç¯‡ (11/13) ã€‚

***

> $keywords$ :
>
> å®Œå…¨äºŒå‰æ ‘ä¸‹æ ‡æ€§è´¨ / åˆ†æ²»ç®—æ³• / å•ç‚¹æŸ¥è¯¢ (ç»´æŠ¤æˆ–ä¸ç»´æŠ¤ $nums$) / å•ç‚¹ä¿®æ”¹ ($add$ & $update$) / (å¢é‡å¼ & è¦†ç›–å¼) åŒºé—´ä¿®æ”¹ / åŒºé—´æŸ¥è¯¢ (æ±‚å’Œ & æ±‚æœ€å€¼) / å †å¼ (é™æ€) çº¿æ®µæ ‘ / æ‡’æƒ°æ ‡è®° / å»¶è¿Ÿä¿®æ”¹ / ç¦»æ•£åŒ– (æ¾ç¦»æ•£ & ç´§ç¦»æ•£) / å¼ºåˆ¶åœ¨çº¿ / åŠ¨æ€å¼€ç‚¹ / ç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ / ç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•åŠ¨æ€çº¿æ®µæ ‘



**çº¿æ®µæ ‘** æ˜¯è‘—åçš„ç”¨äºé«˜æ•ˆæ±‚è§£ **ã€ŒåŒºé—´é—®é¢˜ã€** çš„æ•°æ®ç»“æ„ã€‚ã€ŒåŒºé—´é—®é¢˜ã€å³å¯¹äºè¾“å…¥æ•°ç»„ $nums$ ï¼Œåœ¨å…¶ä¸Šæ‰§è¡Œ **ã€ŒåŒºé—´æ±‚å’Œã€** ã€ **ã€ŒåŒºé—´ä¿®æ”¹ã€** ç­‰æ“ä½œï¼Œé€šå¸¸è¿˜ä¼´éšç€é’ˆå¯¹å•ä¸ªå…ƒç´ çš„ **ã€Œå•ç‚¹æŸ¥è¯¢ã€** ã€ **ã€Œå•ç‚¹ä¿®æ”¹ã€** è¿™ä¸¤ç§å•ç‚¹æ“ä½œã€‚è‹¥ç›´æ¥æ“ä½œ $nums$ ï¼Œåˆ™å•ç‚¹æ“ä½œæ—¶é—´å¤æ‚åº¦ä¸º $O(1)$ ï¼Œè€ŒåŒºé—´æ“ä½œä¸º $O(n)$ ï¼›è‹¥é‡‡ç”¨ã€Œå‰ç¼€å’Œã€ï¼Œåˆ™åŒºé—´æ“ä½œä¸º $O(1)$ ï¼Œè€Œå•ç‚¹æ“ä½œä¸º $O(n)$ ã€‚åˆ©ç”¨å®Œå…¨äºŒå‰æ ‘ä¸‹æ ‡ç‰¹ç‚¹ (é™æ€å †å¼çº¿æ®µæ ‘) æˆ–åŠ¨æ€å¼€ç‚¹æ“ä½œ (åŠ¨æ€çº¿æ®µæ ‘)ï¼Œå°† $nums$ ä¸Šå¯¹ä»»æ„å…ƒç´ å€¼æˆ–ä»»æ„åŒºé—´å€¼ (åŒºé—´æ±‚å’Œã€åŒºé—´æœ€å€¼ç­‰) çš„æ±‚è§£ï¼Œæ„å»ºåœ¨ä¸€æ£µäºŒå‰æ ‘ä¸Šï¼Œé€šè¿‡å¯¹è¯¥äºŒå‰æ ‘çš„åˆ†æ²»å¤„ç† ($dfs$) ï¼Œ**åŒæ—¶å®ç° $O(logn)$ æ—¶é—´å¤æ‚åº¦çš„å•ç‚¹æ“ä½œä¸åŒºé—´æ“ä½œ** ã€‚

æœ¬æ–‡è¡Œæ–‡è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šå°†çº¿æ®µæ ‘ä¸å¦ä¸€ç§æ±‚è§£åŒºé—´é—®é¢˜çš„æ•°æ®ç»“æ„ â€“â€“ ã€Œæ ‘çŠ¶æ•°ç»„ã€åšå¯¹æ¯”ã€‚è™½ç„¶ã€Œçº¿æ®µæ ‘ã€ä¸ã€Œæ ‘çŠ¶æ•°ç»„ã€åœ¨åŸç†ä¸Šå·®åˆ«ä¸å°ï¼Œä½† **ã€ŒåŒºé—´åˆ’åˆ†ã€** çš„æ€æƒ³æ˜¯ä¸€è‡´çš„ã€‚ã€Œæ ‘çŠ¶æ•°ç»„ã€çš„ç‰¹ç‚¹æ˜¯æ€ç»´éš¾åº¦å¤§ï¼Œå®ç°ç®€å•ï¼Œã€Œçº¿æ®µæ ‘ã€æ­£å¥½ç›¸åï¼Œæ€ç»´éš¾åº¦ä½ï¼Œå®ç°ç›¸å¯¹å¤æ‚ï¼Œä¸”å¯¹äºåŒºé—´é—®é¢˜ï¼Œçº¿æ®µæ ‘æ¯”æ ‘çŠ¶æ•°ç»„æ›´å…·æ™®é€‚æ€§ã€‚ä¸è¿‡æˆ‘ä»ç„¶å»ºè®®ä½ åœ¨é˜…è¯»æœ¬æ–‡ä¹‹å‰å…ˆé˜…è¯» [æ ‘çŠ¶æ•°ç»„](https://leetcode.cn/circle/discuss/qGREiN/) ä¸€æ–‡ï¼Œå³ä¾¿æš‚æ—¶ç†è§£ä¸äº†æ ‘çŠ¶æ•°ç»„ä¸­ $lowbit$ çš„ä½œç”¨ä¹Ÿæ²¡å…³ç³»ï¼Œæœ‰äº†ã€Œæ ‘ã€ä¸ã€ŒåŒºé—´é—®é¢˜ã€ç›¸è”ç³»çš„å°è±¡åï¼Œå†å­¦ä¹ æœ¬æ–‡çš„ã€Œçº¿æ®µæ ‘ã€ï¼Œç„¶åå†è¿”å›å»å­¦ä¹ ã€Œæ ‘çŠ¶æ•°ç»„ã€ï¼Œæ•ˆæœä¹Ÿè®¸æ›´å¥½ï¼ˆä¸»è¦æ˜¯æˆ‘å…ˆå†™äº†ã€Œæ ‘çŠ¶æ•°ç»„ã€å†å†™çš„ã€Œçº¿æ®µæ ‘ã€ğŸ˜…ï¼‰ã€‚



æœ¬æ–‡å°†ç»™å‡º **åç§** çº¿æ®µæ ‘çš„å®Œæ•´ç±»å®ç°ä»£ç  (é™æ€ & åŠ¨æ€)ï¼Œå¯åº”å¯¹åŠ›æ‰£ä¸­å‡ºç°çš„ **(å‡ ä¹) æ‰€æœ‰èƒ½ç”¨çº¿æ®µæ ‘è§£å†³çš„é¢˜ç›®** ã€‚å¹¶åœ¨ã€Œå®æˆ˜åº”ç”¨ã€ä¸­ç»™å‡ºè¿‘åé“åŠ›æ‰£ä¸Šçš„çº¿æ®µæ ‘é¢˜ç›®åŠè¯¦ç»†é¢˜è§£ (æŒç»­å¢åŠ ä¸­)ã€‚

å¦å¤–ï¼Œæœ¬æ–‡åŸé¢˜ ã€Œçº¿æ®µæ ‘ (æ ‘ADTè¿è½½ 11/13)ã€ï¼Œååˆ†å¹²ç˜ªï¼Œä¸å¤ªç¬¦åˆä½œè€…çš„æ°”è´¨ï¼Œé‚æ”¹ä¸ºç°æ ‡é¢˜ã€‚**ã€Œæ€¥åœã€è¡¨ç¤ºä½œè€…çš„ä¸€ç§å¸Œæœ›**ï¼Œæˆ‘çŒœæƒ³è®¸å¤šæœ‹å‹è·Ÿä½œè€…ä¸€æ ·ï¼Œåœ¨æ±‚ç´¢çº¿æ®µæ ‘çš„è·¯ä¸Šç‹¼å¥”è±•çªï¼Œç›¸å…³æ–‡ç« å’Œé¢˜è§£çœ‹äº†ä¸å°‘ï¼Œå´å§‹ç»ˆä¸å¾—å…¶æ³•ã€‚ç°åœ¨ï¼Œä½œè€…å¸Œæœ›æœ‹å‹ä»¬èƒ½å¤Ÿé€šè¿‡æœ¬æ–‡å®ç°å®Œç¾æ€¥åœï¼Œæ­¤å **ä»å®¹åŸå•¸ä¸”å¾è¡Œ**ã€‚

***

yukiçš„å…¶ä»–æ–‡ç« å¦‚ä¸‹ï¼Œæ¬¢è¿é˜…è¯»æŒ‡æ­£ï¼

| æ–‡ç«                                                          | [å‘å¸ƒæ—¶é—´] å­—æ•°/è§ˆ/è—/èµ (~09-23)        |
| ------------------------------------------------------------ | ---------------------------------------- |
| [åå¤§æ’åºä»å…¥é—¨åˆ°å…¥èµ˜](https://leetcode.cn/circle/discuss/eBo9UB/)  ğŸ”¥ğŸ”¥ğŸ”¥ | [20220516]  2.5ä¸‡å­—/58.2kè§ˆ/3.5kè—/865èµ |
| [äºŒåˆ†æŸ¥æ‰¾ä»å…¥é—¨åˆ°å…¥ç¡](https://leetcode.cn/circle/discuss/ooxfo8/) ğŸ”¥ğŸ”¥ğŸ”¥ | [20220509]  2.3ä¸‡å­—/35.9kè§ˆ/2.1kè—/484èµ |
| [å¹¶æŸ¥é›†ä»å…¥é—¨åˆ°å‡ºé—¨](https://leetcode.cn/circle/discuss/qmjuMW/) ğŸ”¥ğŸ”¥ | [20220514]  1.2ä¸‡å­—/15.1kè§ˆ/924è—/279èµ  |
| [å›¾è®ºç®—æ³•ä»å…¥é—¨åˆ°æ”¾ä¸‹](https://leetcode.cn/circle/discuss/FyPTTM/) ğŸ”¥ğŸ”¥ | [20220617]  5.6ä¸‡å­—/17.3kè§ˆ/1.2kè—/341èµ |
| æ ‘ADTç³»åˆ— (é¢„è®¡13ç¯‡)                                         | ç³»åˆ—æ–‡ç« ï¼Œè¿è½½ä¸­                         |
| 3. [äºŒå‰æŸ¥æ‰¾æ ‘](https://leetcode.cn/circle/discuss/wPzlSb/)  | [20220801]  5åƒå­—                        |
| 4. [AVLæ ‘](https://leetcode.cn/circle/discuss/zbwD3p/)       | [20220817]  5åƒå­—                        |
| 5. [splayæ ‘](https://leetcode.cn/circle/discuss/BCK17f/)     | [20220817]  5åƒå­—                        |
| 6. [çº¢é»‘æ ‘ä»å…¥é—¨åˆ°çœ‹å¼€](https://leetcode.cn/circle/discuss/SwgIJV/) ğŸ”¥ğŸ¤¯ğŸ¤¯ğŸ¤¯ | [20220915]  3ä¸‡å­—/3.1kè§ˆ/186è—/52èµ      |
| 10. [æ ‘çŠ¶æ•°ç»„ä»å…¥é—¨åˆ°ä¸‹è½¦](https://leetcode.cn/circle/discuss/qGREiN/) ğŸ”¥ğŸ¤¯ | [20220722]  1.1ä¸‡å­—/3.9kè§ˆ/129è—/49èµ    |
| 11. [çº¿æ®µæ ‘ä»å…¥é—¨åˆ°æ€¥åœ](https://leetcode.cn/circle/discuss/H4aMOn/) ğŸ”¥ğŸ¤¯ | [20220726]  2.5ä¸‡å­—/4.8kè§ˆ/324è—/93èµ    |
| [å›¾è®ºç›¸å…³è¯æ˜ç³»åˆ—](https://leetcode.cn/circle/discuss/GV0JrV/) | ç³»åˆ—æ–‡ç«                                  |
| 1. [Dijkstraæ­£ç¡®æ€§è¯æ˜](https://leetcode.cn/circle/discuss/jJQn7V/) ğŸ¤¯ | [20220531]                               |
| 2. [Primæ­£ç¡®æ€§è¯æ˜](https://leetcode.cn/circle/discuss/VVEc8f/) ğŸ¤¯ | [20220919]                               |
| 3. [Bellman-FordåŠSPFAæ­£ç¡®æ€§è¯æ˜](https://leetcode.cn/circle/discuss/xeEwYl/) | [20220602]                               |
| 4. [Floydæ­£ç¡®æ€§è¯æ˜](https://leetcode.cn/circle/discuss/Nbzix4/) | [20220602]                               |
| 5. [æœ€å¤§æµæœ€å°å‰²å®šç†è¯æ˜](https://leetcode.cn/circle/discuss/tMIy36/) ğŸ¤¯ğŸ¤¯ | [20220719]                               |
| 6. [Edmonds-Karpå¤æ‚åº¦è¯æ˜](https://leetcode.cn/circle/discuss/tN3sZc/) ğŸ¤¯ğŸ¤¯ | [20220515]                               |
| 7. [Dinicå¤æ‚åº¦è¯æ˜](https://leetcode.cn/circle/discuss/T9Xa1R/) ğŸ¤¯ğŸ¤¯ | [20220531]                               |



***

[2022-09-23]

- åœ¨ã€Œå®æˆ˜åº”ç”¨ã€ä¸­å¢åŠ  [2407. æœ€é•¿é€’å¢å­åºåˆ— II](https://leetcode.cn/problems/longest-increasing-subsequence-ii/) çš„ [é¢˜è§£](https://leetcode.cn/problems/longest-increasing-subsequence-ii/solution/-by-yukiyama-khmm/) ã€‚
- å¢åŠ ä¸¤ç§ä»¥ $O(logn)$ å®ç°åŒºé—´æœ€å€¼æŸ¥è¯¢çš„çº¿æ®µæ ‘ç±»å®ç°ã€‚

[2022-09-22]

- å¢åŠ äº†ã€ŒåŒºé—´æœ€å€¼æŸ¥è¯¢ã€å°èŠ‚ï¼Œæ›¿æ¢äº†ä¸€å¼ é”™è¯¯å›¾ç‰‡ï¼Œå¦æœ‰è‹¥å¹²è¯å¥ä¿®æ”¹ã€‚

***

[TOC]

***

## çº¿æ®µæ ‘

æˆ‘ä»¬å·²ç»çŸ¥é“ï¼Œé’ˆå¯¹åºåˆ—ä¸Šçš„ã€ŒåŒºé—´æ“ä½œã€ï¼Œç›¸æ¯”æ™®é€šæ•°ç»„å’Œå‰ç¼€å’Œæ•°ç»„ï¼ŒåŸºæœ¬æ ‘çŠ¶æ•°ç»„ (PURQ BIT) å¯¹ã€Œå•ç‚¹ä¿®æ”¹ã€åŠã€ŒåŒºé—´æŸ¥è¯¢ã€è¿™ä¸¤ç§æ“ä½œå®ç°äº†å¹³è¡¡ï¼Œå³å‡ä¸º $O(logn)$ æ—¶é—´å¤æ‚åº¦ã€‚å€ŸåŠ©å·®åˆ†æ•°ç»„ï¼Œä» PURQ BIT å‘å±•è€Œæ¥çš„ RUPQ BIT (åŒºé—´ä¿®æ”¹å•ç‚¹æŸ¥è¯¢) å’Œ RURQ BIT (åŒºé—´ä¿®æ”¹åŒºé—´æŸ¥è¯¢) è¿˜å¯ä»¥å®ç° $O(logn)$ å¤æ‚åº¦åŒºé—´ä¿®æ”¹æ“ä½œï¼Œä½†éœ€è¦é’ˆå¯¹ä¸åŒçš„éœ€è¦é€‰æ‹©ä¸åŒç‰ˆæœ¬çš„æ ‘çŠ¶æ•°ç»„ã€‚å¦å¤–ï¼Œå½“æˆ‘ä»¬éœ€è¦ **å°†åŒºé—´å†…å…ƒç´ ä¿®æ”¹ä¸ºåŒä¸€å…ƒç´ æ—¶** ï¼Œæˆ–è€…æ±‚ç»™å®šåŒºé—´çš„ **åŒºé—´æœ€å¤§/æœ€å°å€¼** æ—¶ï¼Œä¸‰ç§æ ‘çŠ¶æ•°ç»„å‡ä¸èƒ½ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®Œæˆè¯¥æ“ä½œã€‚

å¯¹äºè¿™äº›éœ€æ±‚ï¼Œçº¿æ®µæ ‘éƒ½èƒ½å¤Ÿä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®Œæˆ ã€‚

[çº¿æ®µæ ‘ (Segment Tree)](https://en.wikipedia.org/wiki/Segment_tree): çº¿æ®µæ ‘æ˜¯ä¸€ç§ç”¨ä»¥æ”¯æŒåºåˆ—åŒºé—´æ“ä½œçš„æ•°æ®ç»“æ„ï¼Œç›¸æ¯”åŸºæœ¬æ ‘çŠ¶æ•°ç»„ï¼Œèƒ½å¤Ÿæ”¯æŒçš„æ“ä½œç§ç±»æ›´å¤šï¼Œå› æ­¤å¯¹ä¸€èˆ¬çš„åºåˆ—åŒºé—´é—®é¢˜æ›´å…· **æ™®é€‚æ€§** ã€‚



åœ¨åç»­å†…å®¹ä¸­ï¼Œæˆ‘ä»¬å…ˆé€šè¿‡ **ã€Œå®Œå…¨äºŒå‰æ ‘ä¸‹æ ‡æ€§è´¨ã€** å’Œ **ã€Œåˆ†æ²»ç®—æ³•ã€** æ¥ç†è§£åŸºæœ¬çº¿æ®µæ ‘çš„å·¥ä½œåŸç†ã€‚åœ¨æŒæ¡äº†æ”¯æŒã€Œå•ç‚¹ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æŸ¥è¯¢ã€çš„åŸºæœ¬çº¿æ®µæ ‘åï¼Œå¼•å…¥  **ã€Œæ‡’æƒ°æ ‡è®°ã€** å’Œ **ã€Œå»¶è¿Ÿä¿®æ”¹ã€** çš„æ¦‚å¿µï¼Œç”¨ä»¥å®ç° ã€ŒåŒºé—´ä¿®æ”¹ã€ã€‚åœ¨ç»™å‡ºå¸¦æ‡’æƒ°æ ‡è®°çš„çº¿æ®µæ ‘å®ç°åï¼Œæˆ‘ä»¬é©¬ä¸Šå°è¯•è§£å†³  [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) ï¼Œä¸ºè§£å†³æ­¤é¢˜éœ€å€Ÿç”¨åœ¨ã€Œæ ‘çŠ¶æ•°ç»„ã€ä¸­ä»‹ç»è¿‡çš„ **ã€Œç¦»æ•£åŒ–ã€** æ–¹æ³•ï¼Œæˆ‘å°†ç»™å‡º **ã€Œæ¾ç¦»æ•£ã€** å’Œ **ã€Œç´§ç¦»æ•£ã€** ä¸¤ç§ç¦»æ•£åŒ–å®ç° (æˆ‘è‡ªå·±çå‘½åçš„)ã€‚æ¥ç€å°è¯•è§£å†³  [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) ï¼Œå¹¶å‘ç°è¯¥é¢˜å…·æœ‰ã€Œ[å¼ºåˆ¶åœ¨çº¿](https://en.wikipedia.org/wiki/Online_algorithm)ã€çš„ç‰¹ç‚¹ï¼Œç”±äºæ— æ³•ç¦»æ•£åŒ–ï¼Œè¿™è¦æ±‚æˆ‘ä»¬å®ç°èƒ½å¤Ÿ **ã€ŒåŠ¨æ€å¼€ç‚¹ã€**  (åŠ¨æ€åœ°åˆ›å»ºç»“ç‚¹) çš„çº¿æ®µæ ‘ã€‚æ ¹æ®æ˜¯å¦å¯ä»¥æå‰ä¼°è®¡æ ‘çš„å¤§å°ï¼Œæˆ‘ä»¬å°†åˆ†åˆ«ä»‹ç»  **ã€Œç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ã€** ä»¥åŠ **ã€Œç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ã€** ï¼Œåœ¨ç»™å‡ºå®ƒä»¬çš„å®Œæ•´çš„ç±»ä»£ç åï¼Œæ¼”ç¤ºå¦‚ä½•å°†å…¶ç”¨äºè§£å†³ 699 é¢˜ä»¥åŠ 715 é¢˜ã€‚

åœ¨è®²è§£è¿‡ç¨‹ä¸­ï¼Œæˆ‘ä¼šç»™å‡ºåç§çº¿æ®µæ ‘çš„å®Œæ•´ç±»ä»£ç ï¼ŒåŸºæœ¬èƒ½å¤Ÿè¦†ç›–åŠ›æ‰£ä¸Šçš„æ‰€æœ‰çº¿æ®µæ ‘é¢˜ç›®ã€‚

> çº¿æ®µæ ‘ç”± Jon Bentley äº1977å¹´å‘æ˜ã€‚
>
> The segment tree was invented by [Jon Bentley](https://en.wikipedia.org/wiki/Jon_Bentley_(computer_scientist)) in 1977; in "Solutions to Kleeâ€™s rectangle problems".[[7\]](https://en.wikipedia.org/wiki/Segment_tree#cite_note-Schwarzkopf4-7)
>
> 
>
> ä½œè€…çš„ã€Œçº¿æ®µæ ‘ã€çŸ¥è¯†ï¼Œæœ€åˆå­¦è‡ª OI wiki [çº¿æ®µæ ‘](https://oi-wiki.org/ds/seg/) ã€‚

<br />

### åŸºæœ¬çº¿æ®µæ ‘

å¦‚æœæˆ‘ä»¬åªè¦æ±‚çº¿æ®µæ ‘åƒåŸºæœ¬æ ‘çŠ¶æ•°ç»„ (PURQ BIT) é‚£æ ·åªéœ€æ”¯æŒã€Œå•ç‚¹ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æŸ¥è¯¢ã€ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†å¾—åˆ°æœ€åŸºæœ¬çš„çº¿æ®µæ ‘ã€‚

åœ¨ã€Œæ ‘çŠ¶æ•°ç»„ã€ä¸­æˆ‘ä»¬ä»å¦‚ä½•æé«˜åŒºé—´æŸ¥è¯¢çš„æ•ˆç‡è¿™ä¸€é—®é¢˜å…¥æ‰‹ï¼Œæå‡ºäº†å°†åŸæ•°ç»„ $nums$ åˆ†æˆè‹¥å¹²å­åŒºé—´çš„æƒ³æ³•ï¼Œä¸”è¿™äº›å­åŒºé—´æ„æˆä¸€æ£µé€»è¾‘æ ‘ï¼Œé€šè¿‡æ ‘çš„ç»“æ„å®ç° $O(logn)$ çš„å¤æ‚åº¦ã€‚ä½†æ ‘çŠ¶æ•°ç»„çš„å®ç°å¤ªå…·æŠ€å·§æ€§ï¼Œæˆ‘ä»¬ä¼šæƒ³ï¼Œé™¤äº†æ ‘çŠ¶æ•°ç»„åˆ©ç”¨ $lowbit$ é‚£æ ·å·§å¦™æ„é€ æ ‘çš„æ–¹æ³•ï¼Œæœ‰æ²¡æœ‰ **æ›´ä¸€èˆ¬** çš„æ–¹æ³•èƒ½å¤Ÿå°† $nums$ åˆ’åˆ†ä¸ºå¤šä¸ªå­åŒºé—´ï¼Œè¿™äº›å­åŒºé—´ä½œä¸ºç»“ç‚¹æ„æˆä¸€æ£µæ ‘ï¼Œæ ‘ä¸Šçš„ç»“ç‚¹ç›¸æ¯”æ ‘çŠ¶æ•°ç»„ **æ›´ç›´è§‚** åœ°ç»„æˆä»»æ„åŒºé—´ (ç›´æ¥ç»“åˆè€Œéå‰ç¼€åŒºé—´ä½œå·®)ï¼Œä¸”ä»èƒ½é€šè¿‡ä¸‹æ ‡çš„æŸäº›æ€§è´¨æ¥æ“ä½œç»“ç‚¹å‘¢ (ç›®çš„æ˜¯é€šè¿‡ä¸‹æ ‡å®šä½åˆ°éœ€è¦çš„åŒºé—´å’Œç»“ç‚¹) ï¼Ÿ

æ ¹æ®æ ‘ç»“ç‚¹ä¸‹æ ‡æ€§è´¨æ¥æ“ä½œç»“ç‚¹è¿™ä¸€è¦æ±‚ä¸­ï¼Œæˆ‘ä»¬å—…åˆ°äº† **ã€Œå®Œå…¨äºŒå‰æ ‘ã€** çš„å‘³é“ã€‚åœ¨å®Œå…¨äºŒå‰æ ‘ä¸­ï¼Œç»“ç‚¹ $i$ (æ ¹ç»“ç‚¹ä¸ºç»“ç‚¹ 1) çš„å·¦å­ç»“ç‚¹ä¸‹æ ‡ä¸º $2*i$ ï¼Œå³å­ç»“ç‚¹ä¸‹æ ‡ä¸º $2*i+1$ ã€‚é¡ºç€è¿™ä¸ªæƒ³æ³•ï¼Œæˆ‘ä»¬å°è¯•å°†ã€Œçº¿æ®µæ ‘ã€æ„é€ ä¸ºä¸€æ£µã€Œå®Œå…¨äºŒå‰æ ‘ã€ã€‚

<br />

#### çº¿æ®µæ ‘çš„å½¢æ€

å‡è®¾éœ€è¦åœ¨è¾“å…¥æ•°ç»„ $nums$ ä¸Šæ±‚è§£åŒºé—´é—®é¢˜ï¼Œæˆ‘ä»¬éœ€è¦å°† $nums$ å¤„ç†ä¸ºä¸€æ£µã€Œçº¿æ®µæ ‘ã€ã€‚ä¸‹é¢æ˜¯æˆ‘ä»¬å°†ã€Œçº¿æ®µæ ‘ã€æ„é€ ä¸ºä¸€æ£µã€Œå®Œå…¨äºŒå‰æ ‘ã€çš„æ€è€ƒè¿‡ç¨‹ã€‚

- é¦–å…ˆï¼Œæ—¢ç„¶æ˜¯å®Œå…¨äºŒå‰æ ‘ï¼Œé‚£ä¹ˆè¿™æ£µçº¿æ®µæ ‘å¯ä»¥ä¸ä¸€ä¸ªæ•°ç»„å¯¹åº”ï¼Œæ•°ç»„çš„ä¸€ä¸ªå…ƒç´ å¯¹åº”ä¸€ä¸ªæ ‘çš„ä¸€ä¸ªç»“ç‚¹ã€‚æ ‘çš„ä¸€ä¸ªç»“ç‚¹ä»£è¡¨æŸä¸ªåŒºé—´çš„åŒºé—´å’Œï¼Œæˆ‘ä»¬ç”¨ $tree[]$ æ•°ç»„è¡¨è¾¾è¿™æ£µçº¿æ®µæ ‘ï¼Œå…¶å¤§å°æš‚æ—¶æœªçŸ¥ã€‚

- æ›´å¤§çš„åŒºé—´æ€»æ˜¯ç”±æ›´å°åŒºé—´æ„æˆï¼Œå› æ­¤ä»£è¡¨ $nums$ ä¸­å•ä¸ªå…ƒç´ çš„ç»“ç‚¹ $tree[x]$  **åº”å½“åœ¨æ ‘çš„æœ€åº•å±‚** ï¼Œå³çº¿æ®µæ ‘çš„æ¯ä¸€ä¸ªå¶å­ç»“ç‚¹éƒ½ä¸ $nums$ ä¸­çš„ä¸€ä¸ªå€¼å¯¹åº” $tree[x] = nums[i]$ ï¼Œä¸”æ˜¯ä»å·¦åˆ°å³å¯¹åº”çš„ã€‚
- æ›´å¤§çš„åŒºé—´æ˜¯ä»å¶å­ç»“ç‚¹å¼€å§‹å‘ä¸Šæ„æˆçš„ï¼Œä¾‹å¦‚ä»£è¡¨ $nums[0]$ çš„å¶å­ç»“ç‚¹æ˜¯ä¸€ä¸ªå·¦å­ç»“ç‚¹ï¼Œä»£è¡¨ $nums[1]$ çš„å¶å­ç»“ç‚¹æ˜¯ä¸€ä¸ªå³å­ç»“ç‚¹ï¼Œé‚£ä¹ˆä»–ä»¬çš„çˆ¶èŠ‚ç‚¹å³ä¸ºä»£è¡¨åŒºé—´ $[0,1]$ çš„ç»“ç‚¹ã€‚
- æŸ¥è¯¢åŒºé—´ $[l,r]$ çš„åŒºé—´å’Œï¼Œæ€»æ˜¯ä»ä¸Šåˆ°ä¸‹æŸ¥è¯¢ã€‚ä»æ ¹ç»“ç‚¹å¼€å§‹ï¼Œä¸ºäº†çŸ¥é“æŒ‡å®šåŒºé—´åŒ…å«å“ªäº›åŒºé—´ç»“ç‚¹ï¼Œéœ€è¦å°† $l,r$ ä¸ç»“ç‚¹çš„æ ‡å·è”ç³»èµ·æ¥ï¼Œä¹Ÿå°±æ˜¯å°† $nums$ çš„ä¸‹æ ‡ä¸ **å½¢å¦‚å®Œå…¨äºŒå‰æ ‘çš„çº¿æ®µæ ‘çš„ç»“ç‚¹æ ‡å·** ç›¸è”ç³»ï¼Œè¿™ä¸ªã€Œå®Œå…¨äºŒå‰æ ‘ç»“ç‚¹ä¸‹æ ‡æ€§è´¨ã€æˆ‘ä»¬å¾ˆç†Ÿæ‚‰ï¼Œå°†æ•°ç»„ $nums$ çœ‹ä½œå®Œå…¨äºŒå‰æ ‘æ—¶ï¼Œæ ‘çš„ç»“ç‚¹ä»£è¡¨ $nums$ ä¸­çš„æŸä¸ªå€¼ï¼Œ è€Œåœ¨çº¿æ®µæ ‘ä¸­ï¼Œæ ‘çš„ç»“ç‚¹ä»£è¡¨ $nums$ ä¸­çš„æŸæ®µåŒºé—´å’Œã€‚

åœ¨ç†ŸçŸ¥å®Œå…¨äºŒå‰æ ‘ä¸‹æ ‡æ€§è´¨çš„åŸºç¡€ä¸Šï¼Œä¸Šè¿°åˆ†ææ˜¯ç®€å•çš„ã€‚$tree[i]$ è¡¨ç¤ºæ ‡å·ä¸º $i$ çš„ç»“ç‚¹æ‰€ä»£è¡¨çš„åŒºé—´çš„åŒºé—´å’Œã€‚ä»¤æ ¹ç»“ç‚¹æ ‡å·ä¸º 1ã€‚æ ¹ç»“ç‚¹ $tree[1]$ ä»£è¡¨æ•´ä¸ª $nums$ æ‰€æœ‰å…ƒç´ ä¹‹å’Œã€‚å¾ˆè‡ªç„¶åœ°ï¼Œæ ¹ç»“ç‚¹çš„å·¦å³å­ç»“ç‚¹åº”å½“ä»£è¡¨å·¦å³ä¸¤åŠåŒºé—´çš„åŒºé—´å’Œï¼Œå³ $tree[2]$ è¡¨ç¤ºåŒºé—´ $[0, \frac{n-1}{2}]$ çš„åŒºé—´å’Œï¼Œ$tree[3]$ è¡¨ç¤ºåŒºé—´ $[\frac{n-1}{2}+1, n-1]$ çš„åŒºé—´å’Œï¼Œä¾æ¬¡å‘ä¸‹ï¼Œ **ç»“ç‚¹æ ‡å·æ€»æ˜¯ä¸è¯¥ç»“ç‚¹ä»£è¡¨çš„åŒºé—´ä¸€ä¸€å¯¹åº”** ã€‚

> ä»£è¡¨åŒºé—´ $[l,r]$ çš„ç»“ç‚¹ $tree[i]$ ï¼Œå…¶å·¦å­ç»“ç‚¹ $tree[2*i]$ è¡¨ç¤ºåŒºé—´ $[l,\frac{l+r}{2}]$ çš„åŒºé—´å’Œï¼›å…¶å³å­ç»“ç‚¹ $tree[2*i+1]$ è¡¨ç¤ºåŒºé—´ $[\frac{l+r}{2}+1,r]$ çš„åŒºé—´å’Œã€‚



äºæ˜¯æˆ‘ä»¬å¾ˆå®¹æ˜“å¾—åˆ°çº¿æ®µæ ‘çš„ä¸€èˆ¬è¡¨ç¤ºï¼Œä¸‹å›¾è¡¨ç¤ºå¤§å°ä¸º 15 çš„ $nums=\{a0,a1,...,a14\}$ å¯¹åº”çš„çº¿æ®µæ ‘ã€‚å¯ä»¥çœ‹åˆ°ï¼Œå¯¹äºä»»æ„åŒºé—´ $[l,r], l,râˆˆ[0,n-1]$ ï¼Œæˆ‘ä»¬éƒ½å¯ä»¥ç”± $l$ åˆ° $r$ çš„è‹¥å¹²ä¸ªå­åŒºé—´ç»„åˆå¾—åˆ°ï¼Œè¿™ä¸€ç‚¹æ˜¯çº¿æ®µæ ‘ä¸æ ‘çŠ¶æ•°ç»„çš„æ˜¾è‘—åŒºåˆ« (æ ‘çŠ¶æ•°ç»„é€šè¿‡ä¸¤ä¸ªå‰ç¼€åŒºé—´ä½œå·®å¾—åˆ°)ã€‚ 

![image.png](https://pic.leetcode-cn.com/1658564316-ptpqfb-image.png)

äº†è§£äº†çº¿æ®µæ ‘çš„åŒºé—´åˆ’åˆ†ã€ç»“ç‚¹æ‰€ä»£è¡¨çš„å…·ä½“åŒºé—´ä¸ç»“ç‚¹ä¸‹æ ‡çš„å…³ç³»åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬ç»™å‡ºåŸºæœ¬çº¿æ®µæ ‘çš„ã€Œåˆå§‹åŒ–ã€ã€ã€Œå•ç‚¹ä¿®æ”¹ã€ä»¥åŠã€ŒåŒºé—´æŸ¥è¯¢ã€å®ç°ã€‚åœ¨è¿™ä¹‹å‰å…ˆç®€å•åˆ†æçº¿æ®µæ ‘çš„å¤§å°ã€‚

<br />

#### çº¿æ®µæ ‘çš„å¤§å°

å¯¹äºé•¿åº¦ä¸º $n$ çš„è¾“å…¥æ•°ç»„ $nums$ ï¼Œåˆå§‹åŒ–å®ƒæ‰€å¯¹åº”çš„çº¿æ®µæ ‘å‰ (å³ $tree[]$ æ•°ç»„)ï¼Œæˆ‘ä»¬éœ€è¦çŸ¥é“ $tree[]$ çš„å¤§å°ã€‚$n$ å¯¹åº”çš„æ˜¯çº¿æ®µæ ‘å¶å­ç»“ç‚¹æ•°ï¼Œæˆ‘ä»¬è®¾æ€»ç»“ç‚¹æ•°ä¸º $m$ ï¼Œå¯ä»¥ **æ ¹æ®çº¿æ®µæ ‘ä¸ºä¸€æ£µå®Œå…¨äºŒå‰æ ‘çš„ç‰¹ç‚¹æ¥å¯»æ‰¾ $n$ ä¸ $m$ çš„å…³ç³»** ã€‚è¯æ˜è§ [oi-wiki çº¿æ®µæ ‘](https://oi-wiki.org/ds/seg/) ï¼Œä½œè€…æœªå®Œå…¨çœ‹æ‡‚ $m$ æœ€å¤§æ—¶ä¸º $m=4*n-5$ çš„è¯æ˜è¿‡ç¨‹ã€‚**å¦‚æœè¯»è€…èƒ½æä¾›æ˜“æ‡‚çš„æ•°å­¦è¯æ˜ï¼Œç›¼èµæ•™**ã€‚

æ€»ä¹‹ï¼Œåœ¨å®é™…ä½¿ç”¨æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯ä¸ç²¾ç¡®åœ°ä»¤ $m=4*n$ ã€‚

<br />

#### åˆå§‹åŒ–

å¦‚æœè¯»è€…ç†Ÿæ‚‰å½’å¹¶æ’åºå’Œå¿«é€Ÿæ’åºè¿™ç±» **åˆ†æ²»ç®—æ³•** çš„ã€Œå¯¹åŸé—®é¢˜åŸŸé€’å½’åœ°åˆ’åˆ†ä¸ºå·¦å³å­é—®é¢˜åŸŸã€çš„æ“ä½œï¼Œé‚£ä¹ˆçº¿æ®µæ ‘çš„ä¸»è¦æ–¹æ³•éƒ½å°†æ˜¯ç®€å•çš„ã€‚æˆ‘ä»¬ç›´æ¥ç»™å‡ºå¦‚ä¸‹çº¿æ®µæ ‘ç±» $SegmentTree$ çš„æ„é€ å™¨ä»£ç ã€‚

```java
class SegmentTree {
    int[] nums, tree;
    int n;
    public SegmentTree(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n]; // çº¿æ®µæ ‘ç»“ç‚¹æ•°ä¸è¶…è¿‡ 4*n
        build(0, n - 1, 1);
    }
    private void build(int s, int t, int i){ // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„), i: å½“å‰åŒºé—´ç»“ç‚¹ä¸‹æ ‡
        if(s == t) { // s: start,numså½“å‰åŒºé—´å·¦ç•Œï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´å³ç•Œ
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        tree[i] = tree[i * 2] + tree[i * 2 + 1];
    }
}
```

æ„é€ å™¨é€šè¿‡ `build(0, n - 1, 1)` å®Œæˆçº¿æ®µæ ‘çš„æ„å»º (åˆå§‹åŒ– $tree[]$)ã€‚åœ¨ $build$ ä¸­ï¼Œè‡ªæ ¹ç»“ç‚¹å¾€ä¸‹ï¼ŒæŒ‰ç…§æˆ‘ä»¬åœ¨ã€Œçº¿æ®µæ ‘çš„å½¢æ€ã€ä¸­æ‰€è¯´çš„é‚£æ ·ï¼Œé€’å½’åœ°å°† $nums$ åˆ†ä¸ºå·¦å³ä¸¤åŠï¼Œç›´åˆ°å¶å­ç»“ç‚¹ï¼Œæ¯æ¬¡é€’å½’ï¼Œ **åŒºé—´å’Œç»“ç‚¹çš„ä¸‹æ ‡æ€»æ˜¯å’Œè¯¥åŒºé—´çš„å·¦å³ç•Œä¸€èµ·è¢«ä¼ å…¥** ã€‚è¯¥å†™æ³•å®é™…ä¸Šå°±æ˜¯å¤§å®¶ååˆ†ç†Ÿæ‚‰çš„äºŒå‰æ ‘çš„ã€Œååºéå†ã€å†™æ³•ã€‚

é€’å½’çš„åŸºå‡†æƒ…å½¢æ˜¯æ ¹æ® `s == t` åˆ¤æ–­åˆ°è¾¾å¶å­ç»“ç‚¹åï¼Œä»¤ `tree[i] = nums[s]` ï¼Œä½¿å¾—æ¯ä¸ªå¶å­ç»“ç‚¹ä»å·¦åˆ°å³å¯¹åº” $nums$ çš„æ¯ä¸ªå…ƒç´ å€¼ã€‚åœ¨å›æº¯è¿‡ç¨‹ä¸­é€šè¿‡ `tree[i] = tree[i * 2] + tree[i * 2 + 1]`  è‡ªåº•å‘ä¸Šåœ°åˆå§‹åŒ–æ‰€æœ‰åŒºé—´ç»“ç‚¹çš„åŒºé—´å’Œã€‚è¿™è¡Œè¯­å¥åœ¨çº¿æ®µæ ‘çš„å®ç°ä¸­è¾ƒå¸¸ç”¨ï¼Œæˆ‘ä»¬å¯ä»¥å°†å®ƒå°è£…ä¸ºä¸€ä¸ªè¾…åŠ©æ–¹æ³• $pushUp$ ã€‚

```java
// æ›´æ–° tree[i]
private void pushUp(int i){ 
    tree[i] = tree[i * 2] + tree[i * 2 + 1];
}
```

åé¢æˆ‘ä»¬å°†çœ‹åˆ°ï¼Œçº¿æ®µæ ‘çš„æ‰€æœ‰ä¸»è¦æ–¹æ³•çš„æ‰§è¡Œè¿‡ç¨‹ï¼Œéƒ½æ˜¯ç±»ä¼¼è¿™æ ·çš„ **äºŒå‰æ ‘ååºéå†çš„é€’å½’è¿‡ç¨‹** ï¼Œè¯»è€…ä¸€å®šä¼šæ„Ÿåˆ°çº¿æ®µæ ‘ä¸åŒæ–¹æ³•çš„å†™æ³•å¦‚å‡ºä¸€è¾™ï¼Œç®€å•å¾—ä»¤äººæƒŠè®¶ã€‚

<br />

#### å•ç‚¹ä¿®æ”¹

å•ç‚¹ä¿®æ”¹æœ‰ä¸¤ç§ï¼Œ**å¢é‡å¼ä¿®æ”¹ï¼Œå³åŠ ä¸ŠæŸå€¼** (è®°ä¸º $add$ æ–¹æ³•) $nums[i]+=x$  æˆ– **è¦†ç›–å¼ä¿®æ”¹ï¼Œå³æ”¹ä¸ºæŸå€¼** (è®°ä¸º $update$ æ–¹æ³•) $nums[i]=x$ã€‚å¦‚ä¸‹ã€‚

```java
// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] += x
public void add(int i, int x){ 
    add(i, x, 0, n - 1, 1);
}
// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
public void update(int i, int x){
    update(i, x, 0, n - 1, 1);
}
// å•ç‚¹ä¿®æ”¹: nums[idx] += x
private void add(int idx, int x, int s, int t, int i){
    if(s == t) {
        tree[i] += x; // å¢é‡æ›´æ–°
        return;
    }
    int c = s + (t - s) / 2;
    if(idx <= c) add(idx, x, s, c, i * 2);
    else add(idx, x, c + 1, t, i * 2 + 1);
    pushUp(i);
}
// å•ç‚¹ä¿®æ”¹: nums[idx] = x
private void update(int idx, int x, int s, int t, int i){
    if(s == t) {
        tree[i] = x; // è¦†ç›–æ›´æ–°
        return;
    }
    int c = s + (t - s) / 2;
    if(idx <= c) update(idx, x, s, c, i * 2);
    else update(idx, x, c + 1, t, i * 2 + 1);
    pushUp(i);
}
```

$add$ å’Œ $update$ å‡é‡‡ç”¨ä¸Šè¿°å†™æ³•æ—¶ï¼Œå¯ä»¥ä¸ç”¨ç»´æŠ¤ $nums$ ï¼Œç”±äº $nums$ ä¸å¯ç”¨ï¼Œå•ç‚¹æŸ¥è¯¢å¯å®ç°å¦‚ä¸‹ã€‚

```java
// å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
public int query(int i){ 
    return query(i, 0, n - 1, 1);
}
// å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
private int query(int idx, int s, int t, int i){
    if(s == t) return tree[i];
    int c = s + (t - s) / 2;
    if(idx <= c) return query(idx, s, c, i * 2);
    else return query(idx, c + 1, t, i * 2 + 1);
}
```

å½“ç„¶æˆ‘ä»¬ä¹Ÿå¯ä»¥å®æ—¶åœ°ç»´æŠ¤ $nums$ ï¼Œé‚£ä¹ˆ $add$ å†™æ³•ä¸å˜ï¼Œ $update$ å¯å€ŸåŠ© $add$ å®ç°ã€‚ç”±äº $nums[i]$ æ˜¯å®æ—¶ç»´æŠ¤çš„ï¼Œå•ç‚¹æŸ¥è¯¢æ—¶ç›´æ¥è¿”å› $nums[i]$ å³å¯ã€‚

```java
// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
public void update(int i, int x){ 
    add(i, x - nums[i], 0, n - 1, 1);
    nums[i] = x; // å®æ—¶ç»´æŠ¤ nums[i]
}
public int query(int i){ // å•ç‚¹æŸ¥è¯¢: æŸ¥è¯¢ nums[i]
    return nums[i];
}
```



å®é™…ä¸Šï¼Œç”±äºå•ç‚¹æŸ¥è¯¢å’Œå•ç‚¹ä¿®æ”¹éƒ½å¯ä»¥è§†ä½œåŒºé—´é•¿åº¦ä¸º 1 çš„åŒºé—´æŸ¥è¯¢å’ŒåŒºé—´ä¿®æ”¹ã€‚ä¸Šè¿°æ–¹æ³•ä¹Ÿå¯ä»¥ç”±åŒºé—´æŸ¥è¯¢å’ŒåŒºé—´ä¿®æ”¹ä»£æ›¿ã€‚

<br />

#### åŒºé—´æŸ¥è¯¢

åŒºé—´æŸ¥è¯¢ (æ±‚å’Œ) ä¹Ÿæ˜¯ç®€å•çš„ã€‚ä¸å•ç‚¹æ“ä½œä¸åŒçš„æ˜¯ï¼ŒåŒºé—´å’Œéœ€è¦ç´¯ç§¯ï¼Œå› æ­¤ `if(l <= c)` ä¸ `if(r > c)` æ˜¯å¹¶åˆ—å…³ç³»ã€‚é€’å½’çš„åŸºå‡†æƒ…å½¢ä¸º `if(l <= s && t <= r)` ï¼Œè¡¨ç¤ºå½“å‰é€’è¿›åˆ°çš„åŒºé—´ $[s,t]$ åœ¨æ‰€æ±‚åŒºé—´ $[l,r]$ ä¹‹å†…ï¼Œè¿”å›è¯¥åŒºé—´çš„åŒºé—´å’Œ $tree[i]$ ç”¨äºç´¯è®¡ã€‚

```java
// åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
public int sum(int l, int r){ 
    return sum(l, r, 0, n - 1, 1);
}
// åŒºé—´æŸ¥è¯¢: nums[l]~nums[r]ä¹‹å’Œ
private int sum(int l, int r, int s, int t, int i){
    if(l <= s && t <= r) return tree[i]; // å½“å‰ç»“ç‚¹åŒºé—´åœ¨æ‰€æ±‚èŒƒå›´ä¹‹é—´
    int c = s + (t - s) / 2, sum = 0;
    if(l <= c) sum += sum(l, r, s, c, i * 2); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå·¦ä¾§(å«c)çš„åŒºé—´å’Œ
    if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå³ä¾§çš„åŒºé—´å’Œ
    return sum;
}
```

ä¹Ÿå¯ä»¥æŸ¥è¯¢åŒºé—´æœ€å€¼ï¼Œä»¥åŒºé—´æœ€å°å€¼ä¸ºä¾‹ï¼Œå¦‚ä¸‹ã€‚

```java
// åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
public int min(int l, int r){ 
    return min(l, r, 0, n - 1, 1);
}
// åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
private int min(int l, int r, int s, int t, int i){
    if(s == t) return tree[i]; // å¶å­ç»“ç‚¹
    int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
    if(l <= c) lmin = min(l, r, s, c, i * 2);
    if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
    return Math.min(lmin, rmin);
}
```

<br />

##### åŒºé—´æœ€å€¼æŸ¥è¯¢

**éœ€è¦æ³¨æ„çš„æ˜¯**ï¼Œå¯¹äºã€ŒåŒºé—´æœ€å€¼æŸ¥è¯¢ã€ï¼Œä¸Šé¢ç»™å‡ºçš„ $min$ æ–¹æ³•å»ºç«‹åœ¨ $tree[]$ çš„å®šä¹‰ä¸ºã€ŒåŒºé—´å’Œã€åŸºç¡€ä¹‹ä¸Šã€‚åœ¨è¿™ä¸ªå®šä¹‰ä¸‹ï¼Œç”±äºç¼ºä¹å­åŒºé—´æœ€å€¼çš„è®°å½•ï¼Œä¸ºäº†æ‰¾åˆ°æœ€å€¼ï¼Œ $min$ , $max$ æ–¹æ³•æœ€ç»ˆä¼šé€’è¿›åˆ°åŒºé—´å†…çš„æ¯ä¸€ä¸ªå¶å­ç»“ç‚¹ï¼Œå¦‚æœæŸ¥è¯¢çš„æ˜¯æ•´ä¸ªé—®é¢˜åŒºé—´ä¸Šçš„æœ€å€¼ï¼Œé‚£å°±ç›¸å½“äºç»å†ä¸€æ¬¡å®Œæ•´çš„æ ‘çš„ $dfs$ éå†ï¼Œæ‰€ä»¥å¹³å‡æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n)$ ã€‚è‹¥è¦å®ç° $O(logn)$ å¤æ‚åº¦çš„ã€ŒåŒºé—´æœ€å€¼æŸ¥è¯¢ã€ï¼Œåšæ³•æ˜¯ä»¤ $tree[]$  **è®°å½•åŒºé—´æœ€å€¼** è€Œä¸æ˜¯åŒºé—´å’Œã€‚ä»¥ $tree[]$ è®°å½•åŒºé—´æœ€å€¼çš„å…¸å‹çº¿æ®µæ ‘é¢˜ç›®æ˜¯ [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) ä¸€é¢˜ï¼Œè¯¦ç»†åšæ³•è¯·å‚è€ƒ [é¢˜è§£](https://leetcode.cn/problems/falling-squares/solution/-by-yukiyama-lxtu/) ã€‚å…¶ä¸­æ±‚åŒºé—´æœ€å¤§å€¼çš„ä»£ç å¦‚ä¸‹ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œä¸ $tree[]$ å®šä¹‰ä¸ºã€ŒåŒºé—´å’Œã€æ—¶çš„ã€ŒåŒºé—´æ±‚å’ŒæŸ¥è¯¢ã€çš„ $sum$ æ–¹æ³•ååˆ†ç±»ä¼¼ï¼Œæ ¸å¿ƒå·®åˆ«å°±åœ¨äºé€’å½’çš„ã€ŒåŸºå‡†æƒ…å½¢ã€ï¼Œéœ€è¦å•ä¸ªå¶å­ç»“ç‚¹ä¿¡æ¯æ—¶ï¼Œä¸º `if(s == t) return tree[i];` ï¼Œéœ€è¦åŒ…å«äºæ‰€æ±‚åŒºé—´çš„å½“å‰åŒºé—´ä¿¡æ¯æ—¶ï¼Œä¸º `if(l <= s && t <= r) return tree[i];` ã€‚

```java
// tree[] å®šä¹‰ä¸ºåŒºé—´æœ€å¤§å€¼æ—¶ï¼Œå¯å®ç° O(logn) æ—¶é—´å¤æ‚åº¦çš„åŒºé—´æœ€å€¼æŸ¥è¯¢ã€‚

// åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
public int max(int l, int r){ 
    return max(l, r, 0, n - 1, 1);
}
// åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
private int max(int l, int r, int s, int t, int i){ 
    if(l <= s && t <= r) return tree[i]; // å½“å‰åŒºé—´æ˜¯å¦åŒ…å«åœ¨æ‰€æ±‚åŒºé—´ä¸­
    int c = s + (t - s) / 2, lmax = 0, rmax = 0;
    if(lazy[i] != 0) pushDown(s, c, t, i);
    if(l <= c) lmax = max(l, r, s, c, i * 2);
    if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
    return Math.max(lmax, rmax);
}
```

å¦å¤–è¦æ³¨æ„ç”±äº $tree[]$ çš„æ„ä¹‰æ˜¯åŒºé—´æœ€å€¼ï¼Œå› æ­¤ $pushUp$ æ–¹æ³•ä¹Ÿä¸ä¹‹å‰ä¸åŒï¼Œåº”å¦‚ä¸‹ã€‚

```java
// pushup: æ›´æ–° tree[i]
private void pushUp(int i){
    tree[i] = Math.max(tree[i * 2], tree[i * 2 + 1]);
}
```



å¯¹äºåç»­å…¶ä»–ç‰ˆæœ¬çš„çº¿æ®µæ ‘ï¼Œåªéœ€å°† $tree[]$ å®šä¹‰ä¸ºè®°å½•ã€ŒåŒºé—´æœ€å¤§å€¼ã€ï¼Œç›¸åº”åœ°å®Œæˆä¸Šè¿°ä¸¤å¤„ä¿®æ”¹ï¼Œå³å¯å¾—åˆ°åº”çš„ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®Œæˆã€ŒåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢ã€çš„çº¿æ®µæ ‘ã€‚åŒæ ·åœ°ï¼Œè‹¥æƒ³å¾—åˆ°ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®Œæˆã€ŒåŒºé—´æœ€å°å€¼æŸ¥è¯¢ã€çš„çº¿æ®µæ ‘ï¼Œå°±å°† $tree[]$ å®šä¹‰ä¸ºè®°å½•ã€ŒåŒºé—´æœ€å°å€¼ã€ã€‚ä½†æ˜¯è¦æ³¨æ„ï¼Œå› ä¸º $tree[]$ ä¸å†è®°å½•ã€ŒåŒºé—´å’Œã€ï¼Œåˆ™ $sum$ æ–¹æ³•æ±‚åŒºé—´å’Œéœ€è¦é€’è¿›åˆ°æ¯ä¸€ä¸ªå¶å­ç»“ç‚¹ï¼Œæ­¤æ—¶ $sum$ æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦æ˜¯ $O(n)$ ã€‚

åœ¨ä¸‹é¢çš„ã€Œç±»çš„å®ç°ä»£ç ã€ä¸­ï¼Œåªå±•ç¤ºã€Œä¸ç»´æŠ¤ $nums$ çš„ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®ŒæˆåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢çš„åŸºæœ¬é™æ€çº¿æ®µæ ‘ã€çš„å®Œæ•´ç±»ä»£ç ï¼Œå…¶ä»–ç‰ˆæœ¬è¯»è€…å¯ä»¥è‡ªå·±å†™å‡ºã€‚



è‹¥è¦æ±‚çº¿æ®µæ ‘ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦åŒæ—¶æ”¯æŒã€ŒåŒºé—´å’ŒæŸ¥è¯¢ã€ã€ã€ŒåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢ã€ä»¥åŠã€ŒåŒºé—´æœ€å°å€¼æŸ¥è¯¢ã€ï¼Œåªéœ€è¦åŒæ—¶ç»´æŠ¤ä¸‰ä¸ªæ ‘ç»“ç‚¹å€¼æ•°ç»„å³å¯ï¼Œ$treeSum[],treeMax[],treeMin[]$ åˆ†åˆ«ç”¨æ¥è®°å½•åŒºé—´å’Œã€åŒºé—´æœ€å¤§å€¼ä»¥åŠåŒºé—´æœ€å°å€¼ï¼Œå¹¶ç®€å•ä¿®æ”¹ç›¸å…³ä»£ç å³å¯ã€‚å®Œæ•´å®ç°æ˜¯ã€Œç±»çš„å®ç°ä»£ç ã€ä¸­çš„ã€ŒåŒºé—´æŸ¥è¯¢æ‰©å±•ç‰ˆæœ¬ã€ã€‚

<br />

#### ç±»çš„å®ç°ä»£ç 

å°†å‰è¿°æ–¹æ³•çš„å®ç°ä»£ç ç»„åˆèµ·æ¥å³å¯ (å®æ—¶ç»´æŠ¤ $nums$ æˆ–ä¸ç»´æŠ¤ $nums$ ä¸¤ä¸ªç‰ˆæœ¬)ï¼Œè§åã€‚



ä¸è¿‡ï¼Œæˆ‘ä»¬åœ¨ä¸€å¼€å§‹è¯´è¿‡çº¿æ®µæ ‘èƒ½å¾ˆå¥½åœ°æ”¯æŒã€ŒåŒºé—´ä¿®æ”¹ã€æ“ä½œï¼Œä¸ºä»€ä¹ˆè¿˜æ²¡æä¾›ç›¸å…³æ–¹æ³•å°±åœ¨è¿™é‡Œç»™å‡ºç±»çš„ä»£ç å‘¢ï¼Ÿè¿™æ˜¯å› ä¸ºï¼Œä¸æ ‘çŠ¶æ•°ç»„ (RUPQ/RURQ BIT) åŒºé—´ä¿®æ”¹æ—¶åªéœ€è¦åœ¨ $add$ ä¸­æ²¿ç€çˆ¶é“¾ä¿®æ”¹ $O(logn)$ æ¬¡ä¸åŒï¼Œ **çº¿æ®µæ ‘ä¿®æ”¹ä¸€æ®µåŒºé—´è‡ªä¸Šè€Œä¸‹æ¶‰åŠåˆ°ä¸€ä¸ªæˆ–å¤šä¸ªå­æ ‘ç©ºé—´å†…æ‰€æœ‰ç»“ç‚¹çš„ä¿®æ”¹** ã€‚ä¾‹å¦‚è‹¥ä¿®æ”¹æ•´ä¸ª $nums$ ï¼Œé‚£ä¹ˆå°±è¦ä»æ ¹ç»“ç‚¹ $dfs$ æ•´æ£µæ ‘ï¼Œä¿®æ”¹æ¶‰åŠ **æ‰€æœ‰ç»“ç‚¹** ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ ã€‚å¯¹äºéšæœºåŒºé—´æ¥è¯´ï¼Œå¹³å‡æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ ï¼Œä¸”ç”±äºæ‰€æœ‰åŒºé—´ç»“ç‚¹çš„æ•°é‡å¤§äº $n$ (é€šå¸¸è®¾ç½®ä¸º $4n$)ï¼Œè¿™æ ·çš„æ“ä½œç”šè‡³åŠ£äºç›´æ¥éå† $nums$ é€ä¸ªä¿®æ”¹ã€‚

ä¸ºäº†è§£å†³è¿™ä¸ªé—®é¢˜ï¼Œæˆ‘ä»¬ä¸æ˜¯ç›´æ¥ $dfs$ ä¿®æ”¹ï¼Œè€Œæ˜¯é€šè¿‡ä¸€ç§ç§°ä¸º **ã€Œæ‡’æƒ°æ ‡è®°ã€** çš„æŠ€å·§ï¼Œä½¿å­æ ‘ä¸­çš„ä¿®æ”¹æ“ä½œ **å»¶è¿Ÿ** åˆ°åç»­ä¿®æ”¹å’ŒæŸ¥è¯¢æ“ä½œä¸­ï¼Œæ­¤æŠ€å·§ä½¿å¾—åŒºé—´ä¿®æ”¹çš„æ—¶é—´å¤æ‚åº¦ä»ä¸º $O(logn)$ ã€‚



ä¸ºäº†æ›´ç¨³å›ºåœ°å­¦ä¹ åç»­å†…å®¹ï¼Œå»ºè®®è¯»è€…å…ˆåŸºäºç›®å‰ä¸ºæ­¢è®²è§£çš„å†…å®¹å°è¯•è§£å†³ [307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/) ï¼Œä»£ç å¯å‚è€ƒã€Œå®æˆ˜åº”ç”¨ã€ä¸€èŠ‚ç»™å‡ºçš„é¢˜è§£ã€‚

<br />

##### å®æ—¶ç»´æŠ¤numsçš„ç‰ˆæœ¬

```java
/**
 * åŸºæœ¬çº¿æ®µæ ‘1 (æ— æ‡’æ ‡è®°ï¼Œæ— åŒºé—´ä¿®æ”¹æ–¹æ³•ï¼Œå®æ—¶ç»´æŠ¤ nums[i])
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æŸ¥è¯¢
 */
class SegmentTreeBasic1 {
    int[] nums, tree;
    int n;
    public SegmentTreeBasic1(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
        add(i, x - nums[i], 0, n - 1, 1);
        nums[i] = x; // å®æ—¶ç»´æŠ¤ nums[i]
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢: æŸ¥è¯¢ nums[i]
        return nums[i];
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] += x
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // åŒºé—´æŸ¥è¯¢: nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i]; // å½“å‰ç»“ç‚¹åŒºé—´åœ¨æ‰€æ±‚èŒƒå›´ä¹‹é—´
        int c = s + (t - s) / 2, sum = 0;
        if(l <= c) sum += sum(l, r, s, c, i * 2); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå·¦ä¾§(å«c)çš„åŒºé—´å’Œ
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå³ä¾§çš„åŒºé—´å’Œ
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i]; // å¶å­ç»“ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(l <= c) lmin = min(l, r, s, c, i * 2);
        if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // pushup: æ›´æ–° tree[i]
    private void pushUp(int i){
        tree[i] = tree[i * 2] + tree[i * 2 + 1];
    }
}
```

<br />

##### ä¸ç»´æŠ¤numsçš„ç‰ˆæœ¬

```java
/**
 * åŸºæœ¬çº¿æ®µæ ‘2 (æ— æ‡’æ ‡è®°ï¼Œæ— åŒºé—´ä¿®æ”¹æ–¹æ³•ï¼Œä¸ç»´æŠ¤ nums[i])
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æŸ¥è¯¢
 */
class SegmentTreeBasic2 {
    int[] nums, tree;
    int n;
    public SegmentTreeBasic2(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2;
        if(idx <= c) return query(idx, s, c, i * 2);
        else return query(idx, c + 1, t, i * 2 + 1);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] += x
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] = x
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] = x; // è¦†ç›–æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) update(idx, x, s, c, i * 2);
        else update(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // åŒºé—´æŸ¥è¯¢: nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i]; // å½“å‰ç»“ç‚¹åŒºé—´åœ¨æ‰€æ±‚èŒƒå›´ä¹‹é—´
        int c = s + (t - s) / 2, sum = 0;
        if(l <= c) sum += sum(l, r, s, c, i * 2); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå·¦ä¾§(å«c)çš„åŒºé—´å’Œ
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå³ä¾§çš„åŒºé—´å’Œ
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i]; // å¶å­ç»“ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(l <= c) lmin = min(l, r, s, c, i * 2);
        if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // pushup: æ›´æ–° tree[i]
    private void pushUp(int i){
        tree[i] = tree[i * 2] + tree[i * 2 + 1];
    }
}
```

<br />

##### O(logn)æ—¶é—´æ±‚åŒºé—´æœ€å¤§å€¼ç‰ˆæœ¬

ä»¥ä¸‹æ˜¯ä¸ç»´æŠ¤ $nums$ çš„ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®Œæˆ ã€ŒåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢ã€ çš„åŸºæœ¬é™æ€çº¿æ®µæ ‘ç±»å®ç°ã€‚

```java
/**
 * åŒºé—´æœ€å¤§å€¼åŸºæœ¬çº¿æ®µæ ‘ (æ— æ‡’æ ‡è®°ï¼Œæ— åŒºé—´ä¿®æ”¹æ–¹æ³•ï¼Œä¸ç»´æŠ¤ nums[i])
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æŸ¥è¯¢æœ€å¤§å€¼
 */
class SegmentTreeBasicRangeMax {
    int[] nums, tree;
    int n;
    public SegmentTreeBasicRangeMax(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2;
        if(idx <= c) return query(idx, s, c, i * 2);
        else return query(idx, c + 1, t, i * 2 + 1);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] += x
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] = x
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] = x; // è¦†ç›–æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) update(idx, x, s, c, i * 2);
        else update(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // åŒºé—´æŸ¥è¯¢: nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(s == t) return tree[i]; // è¿”å›æ‰€æ±‚èŒƒå›´å†…çš„å¶å­ç»“ç‚¹çš„å€¼
        int c = s + (t - s) / 2, sum = 0;
        if(l <= c) sum += sum(l, r, s, c, i * 2); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå·¦ä¾§(å«c)çš„åŒºé—´å’Œ
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå³ä¾§çš„åŒºé—´å’Œ
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUp(i);
    }
    // pushup: æ›´æ–° tree[i]
    private void pushUp(int i){
        tree[i] = Math.max(tree[i * 2], tree[i * 2 + 1]);
    }
}
```

<br />

##### åŒºé—´æŸ¥è¯¢æ‰©å±•ç‰ˆæœ¬

ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦åŒæ—¶æ”¯æŒã€ŒåŒºé—´å’ŒæŸ¥è¯¢ã€ã€ã€ŒåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢ã€ä»¥åŠã€ŒåŒºé—´æœ€å°å€¼æŸ¥è¯¢ã€çš„åŸºæœ¬é™æ€çº¿æ®µæ ‘ç±»å®ç°ã€‚

```java
/**
 * åŸºæœ¬çº¿æ®µæ ‘ (æ— æ‡’æ ‡è®°ï¼Œæ— åŒºé—´ä¿®æ”¹æ–¹æ³•ï¼Œä¸ç»´æŠ¤ nums[i])
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æŸ¥è¯¢ (åŒæ—¶æ”¯æŒ O(logn) æ—¶é—´çš„åŒºé—´å’Œï¼ŒåŒºé—´æœ€å¤§å€¼ï¼ŒåŒºé—´æœ€å°å€¼æŸ¥è¯¢)
 */
class SegmentTreeBasic {
    int[] nums, treeSum, treeMin,treeMax;
    int n;
    public SegmentTreeBasic(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.treeSum = new int[4 * n];
        this.treeMin = new int[4 * n];
        this.treeMax = new int[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){// å•ç‚¹ä¿®æ”¹(é©±åŠ¨): nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return treeSum[i];
        int c = s + (t - s) / 2;
        if(idx <= c) return query(idx, s, c, i * 2);
        else return query(idx, c + 1, t, i * 2 + 1);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] += x
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            treeSum[i] += x; // å¢é‡æ›´æ–°
            treeMin[i] += x; // å¢é‡æ›´æ–°
            treeMax[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUpSum(i);
        pushUpMin(i);
        pushUpMax(i);
    }
    // å•ç‚¹ä¿®æ”¹: nums[idx] = x
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            treeSum[i] = x; // è¦†ç›–æ›´æ–°
            treeMin[i] = x; // è¦†ç›–æ›´æ–°
            treeMax[i] = x; // è¦†ç›–æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(idx <= c) update(idx, x, s, c, i * 2);
        else update(idx, x, c + 1, t, i * 2 + 1);
        pushUpSum(i);
        pushUpMin(i);
        pushUpMax(i);
    }
    // åŒºé—´æŸ¥è¯¢: nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return treeSum[i]; 
        int c = s + (t - s) / 2, sum = 0;
        if(l <= c) sum += sum(l, r, s, c, i * 2); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå·¦ä¾§(å«c)çš„åŒºé—´å’Œ
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1); // é€’å½’ç´¯åŠ ç›®æ ‡åŒºé—´è½åœ¨cå³ä¾§çš„åŒºé—´å’Œ
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return treeMin[i];
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(l <= c) lmin = min(l, r, s, c, i * 2);
        if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return treeMax[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            treeSum[i] = nums[s];
            treeMin[i] = nums[s];
            treeMax[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUpSum(i);
        pushUpMin(i);
        pushUpMax(i);
    }
    // pushUpSum: æ›´æ–° treeSum[i]
    private void pushUpSum(int i){
        treeSum[i] = treeSum[i * 2] + treeSum[i * 2 + 1];
    }
    // pushUpMin: æ›´æ–° treeMin[i]
    private void pushUpMin(int i){
        treeMin[i] = Math.min(treeMin[i * 2], treeMin[i * 2 + 1]);
    }
    // pushUpMax: æ›´æ–° treeMax[i]
    private void pushUpMax(int i){
        treeMax[i] = Math.max(treeMax[i * 2], treeMax[i * 2 + 1]);
    }
}
```

<br />

### æ‡’æƒ°æ ‡è®°

å›é¡¾ä¸€ä¸‹å‰è¿° $sum$ æ–¹æ³•ï¼Œç»™å®šåŒºé—´ $[l,r]$ ï¼Œå½“æ–¹æ³•é€’å½’åˆ°ä¸€ä¸ªå®Œå…¨ä½äº $[l,r]$ çš„ $[s,t]$ åŒºé—´ (å³ `l <= s && t <= r` ) æ—¶ï¼Œæˆ‘ä»¬ç›´æ¥ç´¯ç§¯è¯¥åŒºé—´çš„åŒºé—´å’Œã€‚å¯è§ï¼ŒåŒºé—´æŸ¥è¯¢æ—¶ï¼Œåªè¦å½“å‰åŒºé—´å®Œå…¨å¤„äºæŸ¥è¯¢åŒºé—´ä¹‹å†…ï¼Œæˆ‘ä»¬å°±ä¸éœ€è¦çŸ¥é“æ­¤åŒºé—´ä»¥ä¸‹çš„åŒºé—´çš„ä¿¡æ¯ã€‚å› æ­¤å¯¹äºåŒºé—´æŸ¥è¯¢ (æ±‚å’Œ) æ“ä½œï¼Œæ—¶é—´å¤æ‚åº¦æ˜¯ $O(logn)$ ï¼Œé‚£ä¹ˆã€ŒåŒºé—´ä¿®æ”¹ã€è¯¥å¦‚ä½•å®ç°å‘¢ï¼Ÿæ€è€ƒä¸åŒºé—´æŸ¥è¯¢ç±»ä¼¼çš„åšæ³•ï¼ŒåŒºé—´ä¿®æ”¹æ–¹æ³•ä»æ ¹ç»“ç‚¹é€’è¿›åˆ°ä¸€ä¸ª **åŒ…å«äºä¿®æ”¹åŒºé—´ä¹‹å†…çš„åŒºé—´** æ—¶ï¼Œæ˜¯å¦å¯ä»¥ **åªä¿®æ”¹ä»£è¡¨è¯¥åŒºé—´çš„åŒºé—´å’Œ** ï¼Œè€Œä¸å¿…ç»§ç»­æ·±å…¥ä¿®æ”¹å®ƒçš„å­åŒºé—´çš„åŒºé—´å’Œå‘¢ï¼Ÿå› ä¸ºè‹¥ä¿®æ”¹åŒºé—´ä¸‹çš„å­åŒºé—´ (å­æ ‘ç©ºé—´) éƒ½è¦ä¿®æ”¹çš„è¯ï¼Œç›¸å½“äºæ ‘çš„éå†ï¼Œæ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ ï¼Œè€Œæˆ‘ä»¬æƒ³è¦å®ç°æ—¶é—´å¤æ‚åº¦ä¸º $O(logn)$ çš„åŒºé—´ä¿®æ”¹ã€‚ä¸‹é¢æˆ‘ä»¬ä»”ç»†åˆ†æè¿™ä¸€åšæ³•ã€‚

å› ä¸ºé€’å½’æ–¹æ³•æ€»æ˜¯åŒæ—¶ä¼ å…¥ç»“ç‚¹ä¸‹æ ‡ $i$ åŠè¯¥ç»“ç‚¹ä»£è¡¨åŒºé—´çš„å·¦å³ç•Œ $[s,t]$ ï¼Œå› æ­¤å¯ä»¥é€šè¿‡ `if(l <= s && t <= r)` æ¥åˆ¤æ–­å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´æ˜¯å¦å®Œå…¨åŒ…å«äº $[l,r]$ çš„åŒºé—´å†…ï¼Œè‹¥åŒ…å«ï¼Œç”±äºçŸ¥é“å·¦å³ç•Œä¿¡æ¯ï¼Œå› æ­¤å¯ä»¥ç›´æ¥æ›´æ–° $tree[i]$ ã€‚æ­¤åæŸ¥è¯¢åŒ…å« $[s,t]$ çš„åŒºé—´ $[l,r]$ ï¼Œ$dfs$ é€’è¿›åˆ°ä»£è¡¨ $[s,t]$ åŒºé—´çš„ç»“ç‚¹ $tree[i]$ æ—¶ï¼Œ$tree[i]$ æ€»æ˜¯æ­£ç¡®çš„ã€‚ä½†å¦‚æœ $[l,r]$ å€¼åªè¦†ç›–äº†ä¸€éƒ¨åˆ† $[s,t]$ ï¼Œå°±å¿…é¡»ä» $tree[i]$ ç»“ç‚¹ç»§ç»­å‘ä¸‹è®¿é—® $[s,t]$ çš„å­åŒºé—´ï¼Œè€Œå…ˆå‰æˆ‘ä»¬å¹¶æ²¡æœ‰å°†åŒºé—´ä¿®æ”¹è¿›è¡Œåˆ°å­åŒºé—´ï¼Œå› æ­¤æŸ¥è¯¢å°†å¾—ä¸åˆ°æ­£ç¡®ç»“æœã€‚

è§£å†³åŠæ³•æ˜¯åœ¨å‰ä¸€æ¬¡ä¿®æ”¹ $[s,t]$ çš„ $tree[i]$ å€¼æ—¶ï¼Œå¦å¤–ä½¿ç”¨ä¸€ä¸ªä¸ $tree[]$ ç­‰å¤§çš„ $lazy[]$ æ•°ç»„æ ‡è®°æ­¤æ—¶çš„ä¿®æ”¹ (ä¿®æ”¹ $lazy[i]$ )ï¼Œä»¥ä¾¿äºä¸‹æ¬¡æŸ¥è¯¢åˆ° $tree[i]$ æ—¶ **å°†è¿™ä¸ªä¿®æ”¹ä¼ é€’ç»™å­åŒºé—´** ã€‚æˆ‘ä»¬å°†è¿™ä¸ªåŠ¨ä½œç§°ä¸º **ã€Œå»¶è¿Ÿä¿®æ”¹ã€** ï¼Œå°†è¿™ä¸ªæ ‡è®°å½¢è±¡åœ°ç§°ä½œ **ã€Œæ‡’æƒ°æ ‡è®°ã€** ã€‚ä¸å¥½ç†è§£ï¼Ÿæ²¡å…³ç³»ï¼Œæˆ‘ä»¬é©¬ä¸Šç»“åˆç¤ºæ„å›¾ä¸ä»£ç æ¥è·Ÿè¸ªç›¸å…³æ“ä½œã€‚

<br />

#### åŒºé—´ä¿®æ”¹ (å¢é‡å¼)

æˆ‘ä»¬å…ˆåˆ†æ **ä¸ºåŒºé—´å†…æ‰€æœ‰å…ƒç´ å¢åŠ åŒä¸€å€¼çš„ã€Œå¢é‡å¼åŒºé—´ä¿®æ”¹ã€** æ“ä½œã€‚

å¦‚ä¸‹å›¾ï¼Œæ‰§è¡Œ `add(6, 11, 2)` ä¸ºåŒºé—´ $[6,11]$ çš„æ¯ä¸ªå…ƒç´ éƒ½åŠ ä¸Š 2 ã€‚ é€’å½’è°ƒç”¨åˆ° $tree[6]$ ä»¥åŠ $tree[11]$ æ—¶ (æš‚æ—¶å¿½ç•¥é€’è¿›åˆ°æ­¤å¤„ä¹‹å‰çš„æ“ä½œ)ï¼Œä¼šåˆ†åˆ«æ‰§è¡Œ `tree[6] += (11 - 8 + 1) * 2` å’Œ `tree[11] += (7 - 6 + 1) * 2` ã€‚åŒæ—¶ï¼Œå¢é‡ 2 ä¹Ÿä¼šè¢« $lazy[6]$ å’Œ $lazy[11]$ è®°å½•ã€‚ç”±äº **æ ‡è®°å¯èƒ½è¿˜è®°å½•äº†å‰é¢çš„ä¿®æ”¹ï¼Œè€Œä¿®æ”¹æ˜¯å¢é‡å¼çš„ï¼Œå› æ­¤éœ€ç´¯åŠ ** ï¼Œå³ `lazy[6] += 2` åŠ `lazy[11] += 2`ã€‚

![image.png](https://pic.leetcode-cn.com/1663821361-KyUNOS-image.png)



æ¥ç€ï¼Œæˆ‘ä»¬æŸ¥è¯¢ $[6,9]$ çš„åŒºé—´å’Œ ( $sum(6,9)$ )ï¼Œé€’è¿›è®¿é—®åˆ° $tree[6]$ ç»“ç‚¹æ—¶ï¼Œè¦å°†æ‡’æ ‡è®°è®°å½•çš„ä¿®æ”¹é‡ $lazy[6]$ ä¼ é€’ç»™ $tree[12]$ å’Œ $tree[13]$ ã€‚åŒæ ·åœ°ï¼Œè®¿é—®åˆ° $tree[11]$ ç»“ç‚¹æ—¶ï¼Œè¦å°†æ‡’æ ‡è®°è®°å½•çš„ä¿®æ”¹é‡ $lazy[11]$ ä¼ é€’ç»™ $tree[22]$ å’Œ $tree[23]$ ã€‚ **ã€Œæ¨é€ã€** æŒ‡çš„æ˜¯é€šè¿‡ $pushDown$ æ–¹æ³•å®Œæˆ **å½“å‰åŒºé—´ä»¥åŠå®ƒçš„ä¸¤ä¸ªå­ç»“ç‚¹åŒºé—´çš„åŒºé—´å’Œä»¥åŠæ‡’æ ‡è®°çš„æ›´æ–°** ã€‚

![image.png](https://pic.leetcode-cn.com/1658588970-kOwQAr-image.png)



ç°åœ¨æˆ‘ä»¬å¾ˆå®¹æ˜“ç†è§£ä¸‹é¢çš„å®ç°ä»£ç ã€‚`private void add` æ–¹æ³•ä¸­ï¼Œå½“é€’è¿›åˆ°æ‰€ä»£è¡¨çš„åŒºé—´å®Œå…¨åŒ…å«äº $[l,r]$ å†…çš„ $tree[i]$ ç»“ç‚¹æ—¶ (ä»£è¡¨åŒºé—´ $[s,t]$ )ï¼Œæˆ‘ä»¬æ‰§è¡Œ `tree[i] += (t - s + 1) * x` è¯­å¥æ›´æ–° $tree[i]$ ï¼Œæ¥ç€æ‰§è¡Œ `if(s != t) lazy[i] += x`  åè¿”å›ã€‚æ‡’æ ‡è®°æ›´æ–°å‰çš„åˆ¤æ–­ä½¿å¾— **å¶å­ç»“ç‚¹ä¸ä¼šè¢«æ ‡è®°** ï¼Œå› ä¸º **å¶å­ç»“ç‚¹ä¹‹ä¸‹ä¸å†æœ‰éœ€è¦æ¨é€æ ‡è®°çš„ç»“ç‚¹** ã€‚å½“ç„¶ä¹Ÿå¯ä»¥ä¸ç”¨åˆ¤æ–­ï¼Œå› ä¸ºæ— è®ºæ˜¯æŸ¥è¯¢è¿˜æ˜¯ä¿®æ”¹ï¼Œåˆ°è¾¾å¶å­ç»“ç‚¹æ—¶ä¸€å®šä¼šè¿›å…¥æ–¹æ³•å¼€å§‹çš„ $if$ è¯­å¥åé€šè¿‡ $return$ è¿”å›ï¼Œå¶å­ç»“ç‚¹æ²¡æœ‰å‘ä¸‹æ¨é€çš„æœºä¼šã€‚

`if(lazy[i] != 0) pushDown(s, c, t, i)` è¡¨ç¤ºåœ¨é€’å½’è¿›å…¥å·¦å³å­ç»“ç‚¹å‰ï¼Œæ£€æŸ¥å½“å‰ $tree[i]$ é¡¶ç‚¹å€¼æ˜¯å¦è¦å‘ä¸‹æ¨é€æ ‡è®°ï¼Œ`lazy[i] != 0` è¯´æ˜å½“å‰ $tree[i]$ æœ‰ **å°šæœªæ¨é€çš„ä¿®æ”¹** ï¼Œéœ€è¦åœ¨è¿™ä¸ªæ—¶å€™æ¨é€åˆ°ä¸‹ä¸€å±‚ï¼Œå¦åˆ™é€’å½’è¿›å…¥å·¦å³å­ç»“ç‚¹æ—¶ï¼Œå·¦å³å­ç»“ç‚¹çš„åŒºé—´å’Œæ˜¯æ—§çš„ã€‚

$pushDown$ æ–¹æ³•ä¼ å…¥ $s,c,t,i$ ï¼Œç”¨äºæ›´æ–° $tree[i]$ çš„å·¦å­ç»“ç‚¹åŒºé—´å’Œ $tree[2*i]$ ã€å³å­ç»“ç‚¹åŒºé—´å’Œ $tree[2*i+1]$  ä»¥åŠå®ƒä»¬çš„æ‡’æ ‡è®°ã€‚æ›´æ–°ç»“æŸå $tree[i]$ ç»“ç‚¹çš„ã€Œæ¨é€ä¿®æ”¹é‡ã€çš„ä»»åŠ¡å°±å®Œæˆäº†ï¼Œéœ€è¦å°†å…¶æ‡’æ ‡è®°è®¾ç½®ä¸º 0 ï¼Œå³ `lazy[i] = 0` ï¼Œå¦åˆ™ä¸‹æ¬¡ä¿®æ”¹æˆ–æŸ¥è¯¢å†ç»è¿‡ $tree[i]$ æ—¶ï¼Œä¼šé‡å¤æ¨é€ã€‚

$add$ æ–¹æ³•çš„æœ€åä¸€è¡Œè°ƒç”¨ $pushUp$ æ–¹æ³•ï¼Œè¿™æ˜¯é€’å½’çš„ **ã€Œååºã€** åŠ¨ä½œï¼Œå›æº¯è¿‡ç¨‹ä¸­è‡ªåº•å‘ä¸Šæ›´æ–°é€’è¿›è·¯å¾„ä¸Šçš„ $tree[i]$ ã€‚ 

```java
// åŒºé—´ä¿®æ”¹(é©±åŠ¨): [l,r]åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
public void add(int l, int r, int x){ 
    add(l, r, x, 0, n - 1, 1);
}
// åŒºé—´ä¿®æ”¹: å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
private void add(int l, int r, int x, int s, int t, int i){ 
    if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        tree[i] += (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’ŒåŠ ä¸Št-s+1ä¸ªx
        if(s != t) lazy[i] += x; // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œæ‡’æ ‡è®°å€¼åŠ ä¸Šx
        return;
    }
    int c = s + (t - s) / 2;
    if(lazy[i] != 0) pushDown(s, c, t, i); // å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°ä¸ä¸º0ï¼Œæ¨é€æ ‡è®°
    if(l <= c) add(l, r, x, s, c, i * 2);
    if(r > c) add(l, r, x, c + 1, t, i * 2 + 1);
    pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
}
// æ›´æ–°ç»“ç‚¹iå·¦å³å­ç»“ç‚¹çš„åŒºé—´å’Œä»¥åŠæ‡’æƒ°æ ‡è®°å€¼ï¼Œæœ€åé‡ç½®ç»“ç‚¹içš„æ‡’æƒ°æ ‡è®°å€¼
private void pushDown(int s, int c, int t, int i){ 
    tree[i * 2] += (c - s + 1) * lazy[i]; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
    lazy[i * 2] += lazy[i]; // ä¼ é€’æ‡’æ ‡è®°(å¢é‡æ ‡è®°)
    tree[i * 2 + 1] += (t - c) * lazy[i];
    lazy[i * 2 + 1] += lazy[i];
    lazy[i] = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼ï¼ˆå¢é‡æ ‡è®°ç½®0ï¼‰
}
// æ›´æ–° tree[i]
private void pushUp(int i){ 
    tree[i] = tree[i * 2] + tree[i * 2 + 1];
}
```

<br />

#### åŒºé—´ä¿®æ”¹ (è¦†ç›–å¼)

æ¥ç€åˆ†æ **å°†åŒºé—´å†…æ‰€æœ‰å…ƒç´ ä¿®æ”¹ä¸ºåŒä¸€å€¼çš„ã€Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹ã€** æ“ä½œã€‚ä¸å•ç‚¹è¦†ç›–å¼ä¿®æ”¹æ–¹æ³•å¯ä»¥é€šè¿‡è°ƒç”¨å•ç‚¹å¢é‡å¼ä¿®æ”¹æ–¹æ³•æ¥å®ç°ä¸åŒï¼Œç”±äº **æ¶‰åŠå¤šä¸ªå€¼çš„ä¿®æ”¹** ï¼ŒåŒºé—´è¦†ç›–å¼ä¿®æ”¹ä¸èƒ½é€šè¿‡è°ƒç”¨åŒºé—´å¢é‡å¼æ–¹æ³•æ¥å®ç°ã€‚ä¸”è¦†ç›–å¼ä¿®æ”¹å¯èƒ½å°† $nums$ çš„åŸå…ƒç´ å€¼æ”¹ä¸º 0ï¼Œå› æ­¤ä¸èƒ½å†ä»¥ `lazy[i] != 0` æ¥ä½œä¸ºæ¨é€æ ‡è®°çš„æ ‡å¿—ã€‚æˆ‘ä»¬å¯ä»¥åˆ›å»ºä¸€ä¸ªæ–°çš„ `boolean updated[]` æ•°ç»„æ¥è®°å½•ç»“ç‚¹ $i$ å½“å‰çš„ä¿®æ”¹çŠ¶æ€ï¼Œè‹¥ `updated[i] == true` è¯´æ˜ç»“ç‚¹ $i$ çš„ **è¦†ç›–å¼ä¿®æ”¹æœªæ¨é€** ã€‚éœ€æ³¨æ„çš„æ˜¯ï¼Œ $pushDown$ æ–¹æ³•ä¹Ÿéœ€è¦è‹¥å¹²è°ƒæ•´ã€‚å¦‚ä¸‹æ˜¯åŒºé—´è¦†ç›–å¼ä¿®æ”¹çš„ç›¸å…³ä»£ç å®ç°ï¼Œä¸å¢é‡å¼åŒºé—´ä¿®æ”¹ä»£ç çš„åŒºåˆ«ä»…ä»…æ˜¯ç”¨ `if(updated[i])` ä»£æ›¿äº† `if(lazy[i] != 0)` ï¼Œä»¥åŠå°†ã€Œå¢é‡èµ‹å€¼ã€çš„ `+=` æ”¹ä¸ºã€Œè¦†ç›–èµ‹å€¼ã€ `=` ï¼Œä»¥åŠç›¸åº”çš„ $updated[i]$ çš„è®¾ç½®å’Œæ›´æ–°ã€‚

å¦‚æœæˆ‘ä»¬èƒ½ç¡®å®šè¦†ç›–å¼åŒºé—´ä¿®æ”¹ä¸ä¼šå°†å…ƒç´ å€¼æ”¹ä¸º 0 çš„è¯ï¼Œé‚£ $updated[]$ æ•°ç»„ä¸æ˜¯å¿…é¡»çš„ï¼Œä»å¯ç”¨ $lazy[i]$ æ˜¯å¦ä¸º 0 ä½œä¸ºåˆ¤æ–­æ¡ä»¶ï¼Œè¿™ç§æƒ…å†µä¸‹å¢é‡å¼ä¸è¦†ç›–å¼çš„ä»£ç å°†ååˆ†ç›¸ä¼¼ï¼Œå‡ ä¹åªæœ‰ `+=` å’Œ `=` çš„åŒºåˆ«ã€‚ä¾‹å¦‚ [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) ä¸€é¢˜ï¼Œéœ€è¦å®ç°è¦†ç›–å¼åŒºé—´ä¿®æ”¹ï¼Œä½†é¢˜ç›®ä¿è¯äº†ä¿®æ”¹å€¼ä¸ä¼šæ˜¯ 0 ï¼Œå®ç°ä»£ç å°±ä¸éœ€è¦å¦å¤–ä½¿ç”¨ `boolean updated[]` ï¼Œå…·ä½“è¯·çœ‹ã€Œå®æˆ˜åº”ç”¨ã€ä¸­è¯¥é¢˜ [é¢˜è§£](https://leetcode.cn/problems/falling-squares/solution/-by-yukiyama-lxtu/)ã€‚

```java
// åŒºé—´ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
public void update(int l, int r, int x){ 
    update(l, r, x, 0, n - 1, 1);
}
// åŒºé—´ä¿®æ”¹: è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
private void update(int l, int r, int x, int s, int t, int i){ 
    if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        tree[i] = (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’Œç­‰äºt-s+1ä¸ªx
        if(s != t) { // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹
            lazy[i] = x; // æ‡’æ ‡è®°å€¼ç­‰äºx
            updated[i] = true; // updated[i]ç½®äºä¸ºä¸ºtrue
        }
        return;
    }
    int c = s + (t - s) / 2;
    if(updated[i]) pushDown(s, c, t, i); // å½“å‰ç»“ç‚¹updatedä¸ºtrueï¼Œæ¨é€æ ‡è®°
    if(l <= c) update(l, r, x, s, c, i * 2);
    if(r > c) update(l, r, x, c + 1, t, i * 2 + 1);
    pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
}
// æ›´æ–°ç»“ç‚¹iå·¦å³å­ç»“ç‚¹çš„åŒºé—´å’Œ/æ‡’æƒ°æ ‡è®°å€¼/updated[i]ï¼Œæœ€åé‡ç½®æ‡’æƒ°æ ‡è®°å€¼/updated[i]
private void pushDown(int s, int c, int t, int i){ 
    tree[i * 2] = (c - s + 1) * lazy[i]; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
    lazy[i * 2] = lazy[i]; // ä¼ é€’æ‡’æ ‡è®°(è¦†ç›–å¼æ ‡è®°)
    updated[i * 2] = true;
    tree[i * 2 + 1] = (t - c) * lazy[i];
    lazy[i * 2 + 1] = lazy[i];
    updated[i * 2 + 1] = true;
    lazy[i] = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼ï¼ˆè¦†ç›–å¼æ ‡è®°ç½®0ï¼‰
    updated[i] = false; // é‡ç½®å½“å‰ç»“ç‚¹updated[i]ä¸ºfalse
}
```

<br />

#### ç±»çš„å®ç°ä»£ç 

##### å¢é‡å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * é™æ€çº¿æ®µæ ‘ (å¸¦æ‡’æ ‡è®°ï¼Œå¢é‡å¼åŒºé—´ä¿®æ”¹)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æ±‚å’Œ / å¢é‡å¼åŒºé—´ä¿®æ”¹
 */
class SegmentTreeAdd{
    int[] nums, tree, lazy;
    int n;
    public SegmentTreeAdd(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n];
        this.lazy = new int[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public void add(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        add(l, r, x, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] = x; // è¦†ç›–æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, i * 2);
        else update(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) return query(idx, s, c, i * 2);
        else return query(idx, c + 1, t, i * 2 + 1);
    }
    // åŒºé—´ä¿®æ”¹: å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
    private void add(int l, int r, int x, int s, int t, int i){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            tree[i] += (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’ŒåŠ ä¸Št-s+1ä¸ªx
            if(s != t) lazy[i] += x; // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œæ‡’æ ‡è®°å€¼åŠ ä¸Šx
            return;
        }
        int c = s + (t - s) / 2;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) add(l, r, x, s, c, i * 2);
        if(r > c) add(l, r, x, c + 1, t, i * 2 + 1);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i]; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        int c = s + (t - s) / 2, sum = 0;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, i * 2);
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i]; // å¶å­ç»“ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(lazy[i] != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, i * 2);
        if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(lazy[i] != 0) pushDown(s, c, t, i);
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰ç»“ç‚¹åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // pushup: æ›´æ–° tree[i]
    private void pushUp(int i){
        tree[i] = tree[i * 2] + tree[i * 2 + 1];
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°
    private void pushDown(int s, int c, int t, int i){
        tree[i * 2] += (c - s + 1) * lazy[i]; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lazy[i * 2] += lazy[i]; // ä¼ é€’æ‡’æ ‡è®°(å¢é‡æ ‡è®°)
        tree[i * 2 + 1] += (t - c) * lazy[i];
        lazy[i * 2 + 1] += lazy[i];
        lazy[i] = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼ï¼ˆå¢é‡æ ‡è®°ç½®0ï¼‰
    }
}
```

<br />

##### è¦†ç›–å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * é™æ€çº¿æ®µæ ‘ (å¸¦æ‡’æ ‡è®°ï¼Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹ä¸º)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æ±‚å’Œ / è¦†ç›–å¼åŒºé—´ä¿®æ”¹
 */
class SegmentTreeUpdate{
    int[] nums, tree, lazy;
    boolean[] updated;
    int n;
    public SegmentTreeUpdate(int[] nums){
        this.nums = nums;
        this.n = nums.length;
        this.tree = new int[4 * n];
        this.lazy = new int[4 * n];
        this.updated = new boolean[4 * n];
        build(0, n - 1, 1);
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public void update(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
        update(l, r, x, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] += x; // å¢é‡æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(updated[i]) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, i * 2);
        else add(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i] = x; // è¦†ç›–æ›´æ–°
            return;
        }
        int c = s + (t - s) / 2;
        if(updated[i]) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, i * 2);
        else update(idx, x, c + 1, t, i * 2 + 1);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2;
        if(updated[i]) pushDown(s, c, t, i); // å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°ä¸ä¸º0
        if(idx <= c) return query(idx, s, c, i * 2);
        else return query(idx, c + 1, t, i * 2 + 1);
    }
    // åŒºé—´ä¿®æ”¹: è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
    private void update(int l, int r, int x, int s, int t, int i){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            tree[i] = (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’Œç­‰äºt-s+1ä¸ªx
            if(s != t) { // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹
                lazy[i] = x; // æ›´æ–°æ‡’æ ‡è®°
                updated[i] = true; // æ›´æ–°updated
            }
            return;
        }
        int c = s + (t - s) / 2;
        if(updated[i]) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) update(l, r, x, s, c, i * 2);
        if(r > c) update(l, r, x, c + 1, t, i * 2 + 1);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i]; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€è¦æ±‚çš„åŒºé—´ä¹‹å†…
        int c = s + (t - s) / 2, sum = 0;
        if(updated[i]) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, i * 2);
        if(r > c) sum += sum(l, r, c + 1, t, i * 2 + 1);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i]; // å¶å­ç»“ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(updated[i]) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, i * 2);
        if(r > c) rmin = min(l, r, c + 1, t, i * 2 + 1);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i];
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(updated[i]) pushDown(s, c, t, i);
        if(l <= c) lmax = max(l, r, s, c, i * 2);
        if(r > c) rmax = max(l, r, c + 1, t, i * 2 + 1);
        return Math.max(lmax, rmax);
    }
    // æ„å»ºçº¿æ®µæ ‘(treeæ•°ç»„)
    private void build(int s, int t, int i){
        if(s == t) { // s: start,numså½“å‰ç»“ç‚¹åŒºé—´èµ·ç‚¹ä¸‹æ ‡ï¼Œt: terminal,numså½“å‰ç»“ç‚¹åŒºé—´æœ«å°¾ä¸‹æ ‡
            tree[i] = nums[s];
            return;
        }
        int c = s + (t - s) / 2;
        build(s, c, i * 2);
        build(c + 1, t, i * 2 + 1);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // pushup: æ›´æ–° tree[i]
    private void pushUp(int i){
        tree[i] = tree[i * 2] + tree[i * 2 + 1];
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°å’Œupdated
    private void pushDown(int s, int c, int t, int i){
        tree[i * 2] = (c - s + 1) * lazy[i]; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lazy[i * 2] = lazy[i]; // ä¼ é€’æ‡’æ ‡è®°(è¦†ç›–å¼æ ‡è®°)
        updated[i * 2] = true;
        tree[i * 2 + 1] = (t - c) * lazy[i];
        lazy[i * 2 + 1] = lazy[i];
        updated[i * 2 + 1] = true;
        lazy[i] = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼
        updated[i] = false; // é‡ç½®å½“å‰ç»“ç‚¹updated[i]ä¸ºfalse
    }
}
```

<br />

#### å°ç»“

å­¦ä¼šäº†å¸¦æ‡’æƒ°æ ‡è®°çš„çº¿æ®µæ ‘åï¼Œå¯¹äºã€ŒåŒºé—´é—®é¢˜ã€ï¼Œæˆ‘ä»¬ç»ˆäºæŒæ¡äº†ä¸€ä¸ªæ¯”ã€Œæ ‘çŠ¶æ•°ç»„ã€æ›´å¼ºå¤§çš„å·¥å…·ã€‚å¯¹äºå¤§å°ä¸º $n$ çš„åºåˆ— $nums$ ï¼Œå¸¦æ‡’æƒ°æ ‡è®°çš„çº¿æ®µæ ‘ï¼ŒåŒæ—¶ä»¥ $O(logn)$  æ—¶é—´å¤æ‚åº¦æ”¯æŒ **ã€Œå•ç‚¹ä¿®æ”¹ã€ã€ã€Œå•ç‚¹æŸ¥è¯¢ã€ã€ã€ŒåŒºé—´ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æŸ¥è¯¢ã€** ã€‚å…¶ä¸­ï¼Œã€ŒåŒºé—´ä¿®æ”¹ã€æ”¯æŒå¢é‡å¼æˆ–è¦†ç›–å¼ï¼Œã€ŒåŒºé—´æŸ¥è¯¢ã€é™¤äº†èƒ½æ±‚åŒºé—´å’Œï¼Œä¹Ÿå¯ä»¥æ±‚åŒºé—´æœ€å€¼ï¼Œä½†æ˜¯è¦æ³¨æ„ $tree[]$ å®šä¹‰ä¸ºã€ŒåŒºé—´å’Œã€æˆ–ã€ŒåŒºé—´æœ€å€¼ã€æ—¶ï¼Œæ±‚åŒºé—´æœ€å€¼çš„æ–¹æ³•æ—¶é—´å¤æ‚åº¦ä¸åŒï¼Œè¿™ä¸€ç‚¹æˆ‘ä»¬åœ¨ã€ŒåŒºé—´æœ€å€¼æŸ¥è¯¢ã€å°èŠ‚ä¸­å·²ä½œè®¨è®ºã€‚

å®é™…ä¸Šçº¿æ®µæ ‘ç»è¿‡ä¸€äº›è°ƒæ•´ï¼Œèƒ½å¤Ÿå®ç°æ›´å¤šçš„åŒºé—´è¿ç®—ã€‚

<br />

### ç¦»æ•£åŒ–

å½“æˆ‘ä»¬æ»¡æ€€ä¿¡å¿ƒå¸¦ç€å·²æŒæ¡çš„å·¥å…·è¯•å›¾æ±‚è§£çº¿æ®µæ ‘é¢˜ç›®æ—¶ï¼Œæˆ‘ä»¬é©¬ä¸Šä¼šé‡åˆ°ä¸€ä¸ªéš¾é¢˜ â”€â”€ **ç©ºé—´çˆ†ç‚¸**ï¼ä»ä»¥ [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) ä¸ºä¾‹ï¼Œé¢˜æ„ä¸éš¾ç†è§£ï¼Œå®é™…ä¸Šå°±æ˜¯è¦å®ç°ã€Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æœ€å¤§å€¼æŸ¥è¯¢ã€æ“ä½œã€‚æ ¹æ®é¢˜ç›®çš„æ•°æ®èŒƒå›´æç¤ºï¼Œæ±‚è§£åŒºé—´ä» 1 åˆ° **æœ€å³è¾¹æ–¹å—çš„å³ç•Œ** ä¸ºæ­¢ï¼Œè¿™ä¸ªå€¼æ˜¯ $n=10^8+10^6$ ã€‚æŒ‰ç…§æˆ‘ä»¬ç›®å‰ä¸ºæ­¢è®²è§£çš„å †å¼çº¿æ®µæ ‘çš„åšæ³•ï¼Œ$tree[]$ çš„å¤§å°å°†è¾¾åˆ° $4*n=4*(10^8+10^6)$ ï¼Œä¼š $MLE$ ã€‚

è§£å†³è¯¥é—®é¢˜çš„åŠæ³•æˆ‘ä»¬å®é™…ä¸Šå·²åœ¨ã€Œ[æ ‘çŠ¶æ•°ç»„](https://leetcode.cn/circle/discuss/qGREiN/)ã€ä¸­ä»‹ç»è¿‡ï¼Œé‚£å°±æ˜¯åœ¨ä¸å½±å“æ±‚è§£çš„æƒ…å†µä¸‹ï¼Œå…ˆå°†æ±‚è§£åŒºé—´ç¦»æ•£åŒ–ã€‚ä»¥ 699 é¢˜ä¸ºä¾‹ï¼Œæ–¹å— $[l,l+h]$ æ‰è½æ—¶ï¼Œæˆ‘ä»¬é¦–å…ˆåœ¨ $[l,l+h-1]$ åŒºé—´å†…æŸ¥è¯¢æœ€å¤§é«˜åº¦ $height$ ï¼Œç„¶åå°†æ­¤åŒºé—´ä¿®æ”¹ä¸º $h + height$ ã€‚æˆ‘ä»¬å‘ç°ï¼Œåªè¦ä¿è¯æ‰€æœ‰æ–¹å—çš„å·¦å³ç•Œçš„å‰åå…³ç³» (å¤§å°å…³ç³») ä¿æŒä¸å˜ï¼Œ åˆ™åƒä¸‹å›¾é‚£æ ·å°†æ‰€æœ‰æ–¹å—çš„å·¦å³ç•Œä¸€èµ·ç¦»æ•£åŒ–åï¼ŒåŸé—®é¢˜çš„è§£ä¸å˜ã€‚å…·ä½“æ±‚è§£è¿‡ç¨‹å’Œä»£ç å¯å‚è€ƒ [é¢˜è§£](https://leetcode.cn/problems/falling-squares/solution/-by-yukiyama-lxtu/) ã€‚

![image.png](https://pic.leetcode-cn.com/1658738555-GFbSIZ-image.png)

ç¦»æ•£åŒ–ä¸»è¦åˆ†ä¸ºç´§ç¦»æ•£å’Œæ¾ç¦»æ•£ï¼Œå®ƒä»¬éƒ½åŸºäºæ’åºï¼ŒäºŒè€…çš„åŒºåˆ«å·²åœ¨ã€Œ[æ ‘çŠ¶æ•°ç»„](https://leetcode.cn/circle/discuss/qGREiN/)ã€ä¸­è®²è§£è¿‡ã€‚

<br />

#### ç´§ç¦»æ•£

å€ŸåŠ© $set$ å»é‡ï¼Œä½¿å¾—ç¦»æ•£åŒ–åçš„æœ‰æ•ˆæ•°å­—æ›´å°‘ï¼Œå–å€¼èŒƒå›´æ›´å°ã€‚

```java
// ç´§ç¦»æ•£
private Map<Integer, Integer> discrete(int[] nums){ 
    Map<Integer, Integer> map = new HashMap<>();
    Set<Integer> set = new HashSet<>();
    for(int num : nums) set.add(num);
    List<Integer> list = new ArrayList<>(set);
    Collections.sort(list);
    int idx = 0;
    for(int num : list) map.put(num, ++idx);
    return map;
}
```

<br />

#### æ¾ç¦»æ•£

ä¸å€ŸåŠ© $set$ å»é‡ï¼Œç¦»æ•£åŒ–åçš„æœ‰æ•ˆæ•°å­—æ›´å¤š (å­˜åœ¨ç›¸åŒçš„æ•°å­—)ï¼Œå–å€¼èŒƒå›´æ›´å¤§ã€‚

```java
// æ¾ç¦»æ•£
private void discrete(int[] nums){ 
    int n = nums.length;
    int[] tmp = new int[n];
    System.arraycopy(nums, 0, tmp, 0, n);
    Arrays.sort(tmp);
    for (int i = 0; i < n; ++i) {
        nums[i] = Arrays.binarySearch(tmp, nums[i]) + 1;
    }
}
```

<br />

ä¸¾ä¾‹è€Œè¨€ï¼Œå¯¹äº $nums=\{2,4,4,6\}$ ï¼Œæ¾ç¦»æ•£å¾—åˆ° $nums=\{1,2,2,4\}$ï¼Œç¦»æ•£åŒ–åçš„ $nums$ å¤§å°ä¸åŸæ¥ç›¸åŒï¼›ç´§ç¦»æ•£å¾—åˆ° $map=\{(2,1),(4,2),(6,3)\}$ ï¼Œ $key$ ä¸º $nums$ ä¸­çš„å…ƒç´ ï¼Œå¯¹åº”çš„ $value$ ä¸ºå…¶ç¦»æ•£åŒ–å€¼ï¼Œ$value$  ä¸€å®šæ˜¯ä» 1 å¼€å§‹çš„æ²¡æœ‰é‡å¤çš„è¿ç»­æ­£æ•´æ•°ã€‚

ä¸¤ç§æ–¹å¼ç¦»æ•£åŒ–åè™½ç„¶æœ‰æ•ˆæ•°å­—ä¸åŒï¼Œå–å€¼èŒƒå›´ä¹Ÿä¸åŒï¼Œä½†é€šå¸¸éƒ½æ˜¯æœ‰æ•ˆçš„ã€‚æ¾ç¦»æ•£æ— éœ€å“ˆå¸Œè®¡ç®—ï¼Œé€šå¸¸é€Ÿåº¦æ›´å¿«ï¼Œä½†æœ‰çš„é¢˜ç›®å¯èƒ½æ›´é€‚åˆè¿”å› $map$ çš„ç´§ç¦»æ•£ï¼Œå¯æ ¹æ®å®é™…æƒ…å†µé€‰å–åˆé€‚çš„ç¦»æ•£åŒ–æ–¹å¼ã€‚

<br />

### åŠ¨æ€å¼€ç‚¹

ç°åœ¨ï¼Œæœ‰äº†ã€Œç¦»æ•£åŒ–ã€è¿™ä¸€å·¥å…·ï¼Œæˆ‘ä»¬é‡æ–°å‡ºå‘ã€‚åœ¨ç”¨ã€Œç¦»æ•£åŒ–ã€é”¤æ‰ 699 é¢˜ä¹‹åï¼Œç»§ç»­å°è¯•è§£å†³ [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) ä¸€é¢˜ã€‚æŒ‰å¦‚ä¸‹ç†è§£é¢˜æ„ï¼Œä¸éš¾çœ‹å‡ºè¿™ä¹Ÿæ˜¯ä¸€é“éå¸¸å…¸å‹çš„çº¿æ®µæ ‘é¢˜ç›®ã€‚å¯ç”¨æ”¯æŒè¦†ç›–å¼ã€ŒåŒºé—´ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æŸ¥è¯¢ (æ±‚å’Œ)ã€çš„çº¿æ®µæ ‘å®ç°ã€‚

- $addRange$ æ–¹æ³•å³è¦†ç›–å¼ã€ŒåŒºé—´ä¿®æ”¹ã€ï¼Œæˆ‘ä»¬å¯ä»¥è§†ä½œå°†åŒºé—´ $[left,right-1]$ çš„æ¯ä¸ªå…ƒç´ ä¿®æ”¹ä¸º 1ã€‚
- $queryRange$ æ–¹æ³•å³ã€ŒåŒºé—´æŸ¥è¯¢ã€ï¼Œå¯¹åŒºé—´ $[left,right-1]$ æ±‚å’Œï¼Œè‹¥ $sum = right-left$  è¿”å› $true$ ï¼Œå¦åˆ™è¿”å› $false$ ã€‚
- $removeRange$ æ–¹æ³•ä¹Ÿæ˜¯è¦†ç›–å¼ã€ŒåŒºé—´ä¿®æ”¹ã€ï¼Œå°†åŒºé—´ $[left,right-1]$ çš„æ¯ä¸ªå…ƒç´ ä¿®æ”¹ä¸º 0ã€‚

æ ¹æ®é¢˜ç›®ç»™å‡ºçš„å–å€¼èŒƒå›´ï¼Œæˆ‘ä»¬çœ‹åˆ°ã€ŒåŒºé—´ã€èŒƒå›´ä¸º $[1,10^9]$ ï¼Œç›´æ¥ç”¨å †å¼çº¿æ®µæ ‘åˆ™ $tree[]$ æ•°ç»„å¤§å°è¾¾åˆ° $4*10^9$ ï¼Œä¼š $MLE$ ã€‚å½“æˆ‘ä»¬æ‰“ç®—é€šè¿‡ã€Œç¦»æ•£åŒ–ã€æ¥ç¼©å°åŒºé—´æ—¶ï¼Œå‘ç°æœ¬é¢˜æ˜¯ **[å¼ºåˆ¶åœ¨çº¿](https://en.wikipedia.org/wiki/Online_algorithm)** çš„ï¼Œä¹Ÿå°±æ˜¯å¹¶æœªæå‰å‘Šè¯‰æˆ‘ä»¬æ‰€æœ‰æ¶‰åŠè¯¢é—®å’Œä¿®æ”¹çš„åŒºé—´èŒƒå›´ï¼Œå› æ­¤æ— æ³•ç¦»æ•£åŒ–ã€‚

â€» $log(4*10^9) > 31 ï¼Œ2^{31} = 2Gbit$  ï¼Œå› æ­¤è¦åˆ›å»ºå¤§å°ä¸º $4*10^9$ çš„æ•°ç»„ï¼Œå°±éœ€è¦è¶…è¿‡ $2Gb$ çš„ç©ºé—´ã€‚



ç°åœ¨è¯·çœ‹å‘æœ¬å°èŠ‚çš„æ ‡é¢˜ â€”â€” **ã€ŒåŠ¨æ€å¼€ç‚¹ã€** ï¼Œå¦‚æœä½ æ­¤å‰æœ‰ç¥è¿‡ä¸€äº›çº¿æ®µæ ‘çš„æ–‡ç« ï¼Œä½ åº”è¯¥æ²¡å°‘çœ‹åˆ°è¿‡è¿™ä¸ªè¯ã€‚æ€»ä¹‹ä½ å¤§æ¦‚çŸ¥é“æ—¢ç„¶ä¸èƒ½åœ¨ç¨‹åºå¼€å§‹æ—¶å°±å®Œæˆåˆå§‹ã€Œçº¿æ®µæ ‘ã€çš„æ„å»ºçš„è¯ï¼Œé‚£å°±åœ¨åŒºé—´æŸ¥è¯¢æˆ–åŒºé—´ä¿®æ”¹æ—¶ï¼Œæ ¹æ®å±Šæ—¶ä¼ å…¥çš„åŒºé—´ä¿¡æ¯æ¥ã€ŒåŠ¨æ€åœ°ã€åˆ›å»ºç»“ç‚¹ï¼Œé‚£ä¹ˆå¦‚ä½•åšåˆ°å‘¢ï¼Ÿ

ä¸ºäº†å¼•å‡ºå¦‚ä½•åŠ¨æ€åˆ›å»ºç»“ç‚¹ï¼Œæˆ‘ä»¬å…ˆå›é¡¾ã€Œå †å¼çº¿æ®µæ ‘ã€çš„æ“ä½œã€‚æ¯ä¸ªç»“ç‚¹ä»£è¡¨ä¸€ä¸ªç¡®å®šçš„åŒºé—´ï¼Œå½“æˆ‘ä»¬éœ€è¦æŸ¥è¯¢æˆ–ä¿®æ”¹åŒºé—´ $[l,r]$ æ—¶ï¼Œå°±è¦æ‰¾åˆ°ä»£è¡¨ $[l,r]$ çš„è‹¥å¹²ç»“ç‚¹ï¼Œæ“ä½œå®ƒä»¬çš„ $tree[i]$ å€¼å’Œç›¸åº”çš„ $lazy/updated$ (å¦‚æœæœ‰çš„è¯)ã€‚æˆ‘ä»¬éœ€è¦çŸ¥é“æœç´¢è¿‡ç¨‹ä¸­ç»“ç‚¹ä»£è¡¨çš„åŒºé—´èŒƒå›´ $[s,t]$ ï¼Œé€šè¿‡ä¸ $[l,r]$ çš„æ¯”è¾ƒæ¥ç¡®å®šæ˜¯å¦æ˜¯ç›®æ ‡åŒºé—´ï¼ŒåŒæ—¶ä¹Ÿè¦çŸ¥é“è¿™ä¸ªç»“ç‚¹çš„ä¸‹æ ‡ $i$ ä½¿å¾—æˆ‘ä»¬èƒ½å¤Ÿæ“ä½œ $tree[i]$ ï¼Œå› æ­¤ $s,t,i$ ä¸‰è€…æ˜¯ç»‘å®šçš„ã€‚æ€»ä¹‹ï¼ŒæŸ¥æ‰¾ç›®æ ‡åŒºé—´çš„å…³é”®æ˜¯:

> **æ–¹æ³•æ‰§è¡Œè¿‡ç¨‹ä¸­ä¿è¯ç»“ç‚¹å€¼ (æŒ‡ $tree[i]$ï¼Œä¸€èˆ¬ä¸ºåŒºé—´å’Œ ) å’Œè¯¥ç»“ç‚¹ä»£è¡¨çš„åŒºé—´ $[s,t]$ æ˜¯åŒæ—¶è·çŸ¥çš„**ã€‚

å †å¼çº¿æ®µæ ‘é€šè¿‡ $i, 2*i, 2*i+1$ ä¸‹æ ‡å…³ç³»å®ç°äº†è¿™ä¸€ç‚¹ã€‚ä½†åªè¦æˆ‘ä»¬èƒ½å®ç°ä»¥ä¸Šæè¿°ï¼Œçº¿æ®µæ ‘ä¸å¿…æ˜¯ã€Œå †å¼ã€çš„ã€‚



ä¸€ä¸ªç›´æ¥çš„æƒ³æ³•æ˜¯ä¸å†ç”± `int[] tree` æ¥å­˜å‚¨ç»“ç‚¹å€¼ä¿¡æ¯ï¼Œè€Œæ˜¯ä»¥ `Node[] tree` æ¥ç»´æŠ¤ç»“ç‚¹ä¿¡æ¯ï¼Œ$Node$ å¯ä»¥ä½œä¸ºçº¿æ®µæ ‘ç±»ä¸­çš„åµŒå¥—ç±»ï¼Œå®ƒæŒæœ‰ç»“ç‚¹çš„å€¼ä¿¡æ¯ $val$ (ä¸€èˆ¬ä¸ºåŒºé—´å’Œ) ï¼Œæ­¤å¤–è¿˜æŒæœ‰å®ƒçš„å·¦å³å­©å­çš„ä¸‹æ ‡ $lIdx, rIdx$ ï¼Œè¿™æ ·å½“æˆ‘ä»¬è¦é€’å½’è¿›å…¥å·¦å³å­©å­ç»“ç‚¹ (å·¦å³å­åŒºé—´) æ—¶ï¼Œå°±å¯ä»¥ç›´æ¥ä»å½“å‰ç»“ç‚¹è¯»å–ä¸‹æ ‡ï¼Œå°† $tree[tree[i].lIdx]$ æˆ– $tree[tree[i].rIdx]$ ä¼ å…¥æ–¹æ³•ä¸­ï¼Œå®ç°ç»“ç‚¹ä¿¡æ¯ ($tree[tree[i].lIdx].val$ æˆ– $tree[tree[i].rIdx].val$) å’Œ $[s,t]$ çš„åŒæ—¶è·çŸ¥ã€‚

åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬å®é™…ä¸Šå·²ç»ç»™å‡ºäº†ã€ŒåŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ã€çš„ç¬¬ä¸€ç§å®ç°æ–¹å¼ â€”â€” ç»“ç‚¹æ•°ç»„æ³•ã€‚

<br />

#### ç»“ç‚¹æ•°ç»„æ³•

æˆ‘ä»¬ç›´æ¥ç»™å‡ºå¦‚ä¸‹åŒ…å«äº†æ„é€ å™¨å’ŒåŒºé—´ä¿®æ”¹ (å¢é‡å¼) çš„ä»£ç ï¼Œç»“åˆåå›¾åˆ†æ **ã€Œç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ã€** æ˜¯å¦‚ä½•ã€ŒåŠ¨æ€å¼€ç‚¹ã€çš„ã€‚

```java
class DynamicSegmentTreeArrayAdd{ 
    private class Node{
        int lIdx, rIdx, lazy, val;
    }
    Node[] tree;
    int n, count;
    public DynamicSegmentTreeArrayAdd(int n, int m){
        this.n = n;
        this.count = 1;
        this.tree = new Node[m];
    }
    public void add(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        add(l, r, x, 0, n - 1, 1);
    }    
    // åŒºé—´ä¿®æ”¹: å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
    private void add(int l, int r, int x, int s, int t, int i){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            tree[i].val += (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’ŒåŠ ä¸Št-s+1ä¸ªx
            if(s != t) tree[i].lazy += x; // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œæ‡’æ ‡è®°å€¼åŠ ä¸Šx
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) add(l, r, x, s, c, tree[i].lIdx);
        if(r > c) add(l, r, x, c + 1, t, tree[i].rIdx);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(int i){
        if(tree[i] == null) tree[i] = new Node(); // å½“å‰ç»“ç‚¹æœªå»ºï¼Œåˆ›å»ºä¹‹
        if(tree[i].lIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å·¦å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].lIdx = ++count; // èµ‹äºˆç»“ç‚¹æ ‡å·
            tree[tree[i].lIdx] = new Node(); // å¼€è¾Ÿå®ä¾‹
        }
        if(tree[i].rIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å³å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].rIdx = ++count;
            tree[tree[i].rIdx] = new Node();
        }
    }
}
```

é¦–å…ˆçœ‹æ„é€ å™¨ã€‚$n$ æ˜¯è¾“å…¥åŒºé—´çš„å¤§å°ï¼Œå®ƒçš„èŒƒå›´æ˜¯ $[0,n-1]$ ã€‚ **æ•´ä¸ªåŒºé—´çš„èŒƒå›´æ˜¯å¿…é¡»çŸ¥é“çš„** ï¼Œå› ä¸ºæˆ‘ä»¬è¦ä»è¾“å…¥åŒºé—´å¼€å§‹ä¸æ–­åˆ’åˆ†å·¦å³åŒºé—´ï¼Œå› æ­¤è¦ä¼ å…¥ $n$ ã€‚ $m$ æ˜¯ $tree$ çš„å¤§å°ï¼Œå› ä¸ºåœ¨è¿™ä¸ªå®ç°ä¸­ $tree[]$ æ˜¯ $Node$ æ•°ç»„ï¼Œåˆå§‹åŒ–å®ƒå¿…é¡»è¦ç»™å‡ºæ•°ç»„å¤§å°ã€‚åœ¨å †å¼çº¿æ®µæ ‘ä¸­ï¼Œè¿™ä¸ªå¤§å°æ˜¯ $4*n$ ï¼Œä½†å‰é¢å·²ç»è¯´è¿‡ $n$ ç‰¹åˆ«å¤§ï¼Œä¸”ç”±äºã€Œå¼ºåˆ¶åœ¨çº¿ã€è€Œæ— æ³•ç¦»æ•£åŒ–ï¼Œå› æ­¤è¿™ä¸ªå¤§å°éœ€è¦ **ã€Œä¼°è®¡ã€** ï¼Œä¼°è®¡æ–¹æ³•åè¿°ã€‚

æ¥ç€çœ‹åŒºé—´ä¿®æ”¹çš„é©±åŠ¨æ–¹æ³•å’Œå…·ä½“çš„åŒºé—´ä¿®æ”¹æ–¹æ³•ï¼Œå®ƒä»¬ä¸æˆ‘ä»¬å‰é¢ç»™å‡ºçš„å †å¼çº¿æ®µæ ‘çš„å†™æ³•å‡ ä¹ç›¸åŒï¼ŒåŒºåˆ«åªåœ¨äºå¤šäº†ä¸€è¡Œ `addNode(i)` ã€‚ $add$ è¿è¡Œåˆ°æ­¤å¤„æ—¶ï¼Œä¹‹åä¼šåˆ’åˆ†å½“å‰åŒºé—´ä¸ºå·¦å³å­åŒºé—´ï¼Œç„¶åå¸¦ç€åŒºé—´ä¿¡æ¯å’Œå·¦å³å­ç»“ç‚¹çš„ä¿¡æ¯é€’å½’è°ƒç”¨ $add$ (é€’è¿›åˆ°å·¦å³å­ç»“ç‚¹ä¸­) ã€‚ä½†æ˜¯æˆ‘ä»¬ **å°šæœªåˆ›å»ºå·¦å³å­ç»“ç‚¹ï¼Œç”šè‡³å½“å‰ç»“ç‚¹ä¹Ÿå¯èƒ½å°šæœªåˆ›å»º** ï¼Œå› æ­¤å¿…é¡»æ‰§è¡Œ `addNode(i)` ï¼Œæ ¹æ®æ–¹æ³•ä¸­çš„åˆ¤æ–­ç»“æœæ¥å†³å®šæ˜¯å¦è¦åˆ›å»ºå½“å‰ç»“ç‚¹ $tree[i]$ ã€å·¦å­ç»“ç‚¹ $tree[tree[i].lIdx]$  æˆ–å³å­ç»“ç‚¹ $tree[tree[i].rIdx]$ ã€‚æˆ‘ä»¬æ³¨æ„åˆ°ç»“ç‚¹ç¼–å·æ˜¯ä» 1 å¼€å§‹é€’å¢çš„ï¼Œå› æ­¤åˆ¤æ–­æ˜¯å¦å­˜åœ¨å­ç»“ç‚¹æ—¶ï¼Œ å¯ä»¥ä¸å¿…åƒåˆ¤æ–­å½“å‰ç»“ç‚¹æ˜¯å¦å­˜åœ¨é‚£æ ·æ‰§è¡Œ `tree[tree[i].lIdx] == null` è€Œæ˜¯é€šè¿‡ `tree[i].lIdx == 0` æ¥åˆ¤æ–­å³å¯ã€‚



åŒæ ·åœ°ï¼Œå¯¹äºå…¶ä»–æŸ¥è¯¢æˆ–ä¿®æ”¹æ–¹æ³•ï¼Œä¸å †å¼çº¿æ®µæ ‘çš„å®ç°çš„åŒºåˆ«éƒ½åªæ˜¯æ˜¯åœ¨æ–¹æ³•ä¸­å¤šäº† `addNode(i)` è¿™ä¸€è¡Œã€Œå¼€ç‚¹ã€è¯­å¥ï¼Œå¦‚æ­¤å°±å®ç°äº† **åªåœ¨æŸ¥è¯¢æˆ–ä¿®æ”¹æ—¶æŒ‰éœ€åŠ¨æ€åœ°åˆ›å»ºç»“ç‚¹** è¿™ä¸€ç›®æ ‡ã€‚ å®Œæ•´çš„ç±»å®ç°æˆ‘ä»¬æ”¾åœ¨ç¨åçš„ã€Œç±»çš„å®ç°ä»£ç ã€ä¸­ã€‚å¦‚ä¸‹ â‘ ~â‘¨ æ˜¯åœ¨åŒºé—´ä¸º $[0,14]$ çš„è¾“å…¥åºåˆ—ä¸Šä¿®æ”¹åŒºé—´ $[1,3]$ æ—¶ä¾æ¬¡åŠ¨æ€åˆ›å»ºçš„ç»“ç‚¹ï¼Œæ³¨æ„ç»“ç‚¹æ ‡å·æ˜¯ä» 1 å¼€å§‹é€’å¢çš„ã€‚

![image.png](https://pic.leetcode-cn.com/1658817308-RgfxZv-image.png)

<br />

##### é¢„ä¼°ç»“ç‚¹æ•°

$tree[]$ çš„å¤§å° $m$ éœ€è¦é¢„ä¼°ã€‚ä»ä¸Šå›¾è¿‡ç¨‹ä¸­æˆ‘ä»¬çœ‹åˆ°ï¼Œæ¯æ¬¡æŸ¥è¯¢æˆ–ä¿®æ”¹æ“ä½œçš„ã€Œå¼€ç‚¹ã€æ¬¡æ•°ä¸æ ‘é«˜æœ‰å…³ï¼Œæˆ‘ä»¬çŸ¥é“æ ‘é«˜ $h$ ä¸å¶å­ç»“ç‚¹æ•° $n$ (å³æˆ‘ä»¬å¿…é¡»çŸ¥é“çš„åŒºé—´å¤§å°) çš„å…³ç³»ï¼Œå› æ­¤åªè¦èƒ½å¤Ÿæå‰çŸ¥é“æ“ä½œæ€»æ¬¡æ•° (æŸ¥è¯¢å’Œä¿®æ”¹) ï¼Œå¹¶å‡è®¾æŸ¥è¯¢æˆ–ä¿®æ”¹çš„åŒºé—´ **ä¸å¤ªå¤§**ï¼Œæˆ‘ä»¬å°±èƒ½ä¼°è®¡ç»è¿‡æ‰€æœ‰æ“ä½œååˆ›å»ºçš„æ€»çš„ç»“ç‚¹æ•°ï¼Œå³çº¿æ®µæ ‘çš„å¤§å° $m$ã€‚ å¦‚ä¸‹ï¼š

1. æ•´æ£µçº¿æ®µæ ‘çš„ç»“ç‚¹æ•°ä¸ä¼šè¶…è¿‡ $4*n$ ã€‚
2. æ¯æ¬¡æŸ¥è¯¢ä»æ ¹ç»“ç‚¹å¾€ä¸‹ï¼Œåœ¨å‡è®¾æŸ¥è¯¢æˆ–ä¿®æ”¹çš„åŒºé—´ **åªæœ‰ä¸€ä¸ªå€¼** ï¼Œåˆ™æ¯æ¬¡æ“ä½œä»æ ¹ç»“ç‚¹åˆ°è¡¨ç¤ºè¯¥å€¼çš„å¶å­ç»“ç‚¹çš„è·¯å¾„ä¸Šï¼Œæ¯ä¸€å±‚åªä¼šç»è¿‡ä¸€ä¸ªåŒºé—´ï¼Œå¼€ä¸¤ä¸ªç‚¹ã€‚äºæ˜¯å¼€ç‚¹æ¬¡æ•°ä¸ºæ ‘é«˜ $h = \lceil log_{2}(4*n) \rceil -1=log_{2}(4*n)$  (æ ¹ç»“ç‚¹é«˜ 0)ï¼Œæ¯æ¬¡å¼€ä¸¤ä¸ªç‚¹ï¼Œä¸€æ¬¡æŸ¥è¯¢æœ€å¤šæ–°å»º $2*h$ ä¸ªç»“ç‚¹ã€‚ä½†å¹³å‡è€Œè¨€æ“ä½œçš„åŒºé—´å½“ç„¶ä¸ä¼šåªæœ‰ä¸€ä¸ªå€¼ï¼Œå› æ­¤è¿™é‡Œæˆ‘ä»¬è¦é€‚å½“æ”¾å¤§å€æ•°ï¼Œæ ¹æ®ç»éªŒå¯æ”¾å¤§åˆ° $6*h$ ã€‚
3. å‡è®¾æœ‰ $k$ æ¬¡æ“ä½œï¼Œåˆ™æœ‰ä¼°è®¡ $m=6*k*log_{2}(4*n)$ ï¼Œçœç•¥ $6*k*2$ åå¾—åˆ° $m = 6*k*logn$  ã€‚



ç°åœ¨ï¼Œåœ¨å‚è€ƒã€Œç±»çš„å®ç°ä»£ç ã€ä¸­ã€Œç»“ç‚¹æ•°ç»„æ³•ã€ç‰ˆæœ¬çš„ä»£ç ä»¥åŠ [é¢˜è§£](https://leetcode.cn/problems/range-module/solution/yukiyama-by-yukiyama-lyg5/) çš„åŸºç¡€ä¸Šï¼Œåº”å½“å¾ˆå®¹æ˜“å†™å‡ºã€Œç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ã€è§£å†³  [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) ã€‚



åº”ç”¨ç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘è§£å†³ 715é¢˜ æ—¶ï¼Œæˆ‘ä»¬ä¼šæ„Ÿåˆ°  **$m$ çš„é¢„ä¼°ç›¸å¯¹éº»çƒ¦** ï¼Œä¼°è®¡åå°æ—¶è¿˜å¯èƒ½å‡ºç°æ•°ç»„è¶Šç•Œçš„é”™è¯¯ã€‚è®©æˆ‘ä»¬è€ƒè™‘æ›´ä¸¥æ ¼çš„æƒ…å†µã€‚å‡è®¾æ“ä½œæ¬¡æ•°ä¹ŸæœªçŸ¥ï¼Œé‚£ä¹ˆæˆ‘ä»¬å°†æ— æ³•ä¼°è®¡ $m$ ï¼Œä¹Ÿå°±æ— æ³•å¾ˆå¥½åœ°ä½¿ç”¨ç»“ç‚¹ä¸Šæ•°ç»„æ³•æ¥å®ç°åŠ¨æ€çº¿æ®µæ ‘ï¼Œé™¤éåƒ $ArrayList$ å†…éƒ¨åŠ¨æ€æ‰©å±•æ•°ç»„é‚£æ ·ï¼Œå½“ç©ºé—´ä¸å¤Ÿæ—¶å†å°†å½“å‰ $tree[]$ æ‹·è´åˆ°æ–°ç”³è¯·çš„æ›´å¤§çš„ $Node$ æ•°ç»„ä¸­ï¼Œä½†å¦‚æ­¤ä¸€æ¥å•æ¬¡æŸ¥è¯¢æˆ–ä¿®æ”¹çš„æ—¶é—´å¤æ‚åº¦å°±ä¸ä¿è¯æ˜¯ $O(logn)$ äº†ã€‚

é¿å…æ•°ç»„å¤§å°é¢„ä¼°çš„æ€è€ƒå¼•å‡ºä¸‹é¢çš„ **ã€Œç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨)ã€æ³•åŠ¨æ€çº¿æ®µæ ‘ã€** ã€‚

<br />

#### ç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•

é¿å…æ•°ç»„å¤§å°é¢„ä¼°çš„åŠæ³•å¾ˆç®€å•ã€‚æˆ‘ä»¬ä¸å†é€šè¿‡æ•°ç»„æ¥ä¿å­˜ç»“ç‚¹ä¿¡æ¯ï¼Œè€Œæ˜¯åœ¨ $Node$ ä¸­æŒæœ‰åŒæ ·æ˜¯ $Node$ ç±»å‹çš„å·¦å­ç»“ç‚¹ $lChild$ å’Œå³å­ç»“ç‚¹ $rChild$ ã€‚å¦‚æ­¤ä¸€æ¥ï¼Œåœ¨å¤„ç†åˆ°ä»£è¡¨åŒºé—´ $[l,r]$ çš„å½“å‰ç»“ç‚¹ $cur$  æ—¶ï¼Œæˆ‘ä»¬æ€»æ˜¯èƒ½å¤Ÿå°†å·¦å³å­åŒºé—´åˆ†åˆ«ä¸ $cur.lChild$ æˆ– $cur.rChild$ ã€Œç»‘å®šã€èµ·æ¥ã€‚å…¶å®åªè¦è¯»è€…ç†Ÿæ‚‰äºŒå‰æ ‘çš„ä¸€äº›æ“ä½œï¼Œè¯¥æ–¹æ³•åè€Œæ¯”ç»“ç‚¹æ•°ç»„æ³•è¦æ›´å®¹æ˜“æƒ³åˆ°ã€‚

ç»“ç‚¹æŒ‡é’ˆæ³•å®ç°çš„åŠ¨æ€çº¿æ®µæ ‘æ˜¯ç®€å•çš„ã€‚æˆ‘ä»¬ç›´æ¥ç»™å‡ºå¦‚ä¸‹åŒ…å«äº†æ„é€ å™¨å’ŒåŒºé—´ä¿®æ”¹ (å¢é‡å¼) çš„ä»£ç ï¼Œå¯¹æ¯”ã€Œç»“ç‚¹æ•°ç»„ã€æ³•çš„ä»£ç ï¼Œä¸»è¦åŒºåˆ«ä¸ºï¼š

- æŒ‡é’ˆæ³•çš„æŸ¥è¯¢æˆ–ä¿®æ”¹æ–¹æ³•ï¼Œç›´æ¥ä¼ å…¥å½“å‰ç»“ç‚¹ `Node cur` ã€‚
- æŒ‡é’ˆæ³•çš„çº¿æ®µæ ‘ç±»ç»´æŠ¤æ ¹ç»“ç‚¹ $root$ ã€‚
- åŠ¨æ€å¼€ç‚¹æ–¹æ³• $addNode$ ä¸åŒã€‚

```java
class DynamicSegmentTreePointerAdd{
    private class Node{
        int lazy, val;
        Node lChild, rChild;
    }
    int n;
    Node root;
    public DynamicSegmentTreePointerAdd(int n){
        this.n = n;
        this.root = new Node();
    }
    public void add(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        add(l, r, x, 0, n - 1, root);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, Node cur){ 
        if(s == t) {
            cur.val += x; // å¢é‡æ›´æ–°
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°ä¸ä¸º0ï¼Œæ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, cur.lChild);
        else add(idx, x, c + 1, t, cur.rChild);
        pushUp(cur); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(Node node){ 
        if(node.lChild == null) node.lChild = new Node();
        if(node.rChild == null) node.rChild = new Node();
    }
}
```

å®Œæ•´å®ç°è¯·å‚è€ƒã€Œç±»çš„å®ç°ä»£ç ã€ã€‚

ä»å‰é¢ä¸€æ­¥æ­¥çœ‹åˆ°è¿™é‡Œï¼Œæˆ‘ä»¬æ˜æ˜¾æ„Ÿåˆ°åŠ¨æ€å¼€ç‚¹çš„çº¿æ®µæ ‘å¹¶ä¸å¤æ‚ï¼Œç›¸æ¯”é™æ€çº¿æ®µæ ‘ï¼Œå®ç°ä¸Šçš„åŒºåˆ«ä¸è¿‡æ˜¯å¼•å…¥äº†ä¸€ä¸ª $addNode$ æ–¹æ³•ï¼Œå¹¶åœ¨æŸ¥è¯¢å’Œä¿®æ”¹æ–¹æ³•çš„é€‚å½“ä½ç½®è°ƒç”¨è¯¥æ–¹æ³•åŠ¨æ€åœ°åˆ›å»ºç»“ç‚¹è€Œå·²ã€‚



ç°åœ¨ï¼Œåœ¨å‚è€ƒã€Œç±»çš„å®ç°ä»£ç ã€ä¸­ã€Œç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•ã€ç‰ˆæœ¬çš„ä»£ç ä»¥åŠ [é¢˜è§£](https://leetcode.cn/problems/range-module/solution/yukiyama-by-yukiyama-lyg5/) çš„åŸºç¡€ä¸Šï¼Œåº”å½“å¾ˆå®¹æ˜“å†™å‡ºã€Œç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•åŠ¨æ€çº¿æ®µæ ‘ã€è§£å†³  [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) ã€‚

<br />

#### ç±»çš„å®ç°ä»£ç 

##### ç»“ç‚¹æ•°ç»„æ³•

###### å¢é‡å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘æ•°ç»„ç‰ˆ (å¸¦æ‡’æ ‡è®°ï¼Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æ±‚å’Œ / è¦†ç›–å¼åŒºé—´ä¿®æ”¹
 */
class DynamicSegmentTreeArrayAdd{
    private class Node{
        int lIdx, rIdx, lazy, val;
    }
    Node[] tree;
    int n, count;
    public DynamicSegmentTreeArrayAdd(int n, int m){
        this.n = n;
        this.count = 1;
        this.tree = new Node[m];
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public void add(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        add(l, r, x, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i].val += x; // å¢é‡æ›´æ–°
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, tree[i].lIdx);
        else add(idx, x, c + 1, t, tree[i].rIdx);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i].val = x; // è¦†ç›–æ›´æ–°
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, tree[i].lIdx);
        else update(idx, x, c + 1, t, tree[i].rIdx);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹å€¼
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i].val;
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) return query(idx, s, c, tree[i].lIdx);
        else return query(idx, c + 1, t, tree[i].rIdx);
    }
    // åŒºé—´ä¿®æ”¹: å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
    private void add(int l, int r, int x, int s, int t, int i){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            tree[i].val += (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’ŒåŠ ä¸Št-s+1ä¸ªx
            if(s != t) tree[i].lazy += x; // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œæ‡’æ ‡è®°å€¼åŠ ä¸Šx
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) add(l, r, x, s, c, tree[i].lIdx);
        if(r > c) add(l, r, x, c + 1, t, tree[i].rIdx);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i].val; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, sum = 0;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, tree[i].lIdx);
        if(r > c) sum += sum(l, r, c + 1, t, tree[i].rIdx);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i].val; // å¶å­ç»“ç‚¹
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(tree[i].lazy != 0) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, tree[i].lIdx);
        if(r > c) rmin = min(l, r, c + 1, t, tree[i].rIdx);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i].val;
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(tree[i].lazy != 0) pushDown(s, c, t, i);
        if(l <= c) lmax = max(l, r, s, c, tree[i].lIdx);
        if(r > c) rmax = max(l, r, c + 1, t, tree[i].rIdx);
        return Math.max(lmax, rmax);
    }
    // pushup: æ›´æ–° cur.val
    private void pushUp(int i){
        Node cur = tree[i], lChild = tree[cur.lIdx], rChild = tree[cur.rIdx];
        cur.val = lChild.val + rChild.val;
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°
    private void pushDown(int s, int c, int t, int i){
        Node cur = tree[i], lChild = tree[cur.lIdx], rChild = tree[cur.rIdx];
        lChild.val += (c - s + 1) * cur.lazy; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lChild.lazy += cur.lazy; // ä¼ é€’æ‡’æ ‡è®°
        rChild.val += (t - c) * cur.lazy;
        rChild.lazy += cur.lazy;
        cur.lazy = 0;
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(int i){
        if(tree[i] == null) tree[i] = new Node(); // å½“å‰ç»“ç‚¹æœªå»ºï¼Œåˆ›å»ºä¹‹
        if(tree[i].lIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å·¦å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].lIdx = ++count; // èµ‹äºˆç»“ç‚¹æ ‡å·
            tree[tree[i].lIdx] = new Node(); // å¼€è¾Ÿå®ä¾‹
        }
        if(tree[i].rIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å³å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].rIdx = ++count;
            tree[tree[i].rIdx] = new Node();
        }
    }
}
```

<br />

###### è¦†ç›–å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘æ•°ç»„ç‰ˆ (å¸¦æ‡’æ ‡è®°ï¼Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹ä¸º)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æ±‚å’Œ / è¦†ç›–å¼åŒºé—´ä¿®æ”¹
 */
class DynamicSegmentTreeArrayUpdate{
    private class Node{
        int lIdx, rIdx, lazy, val;
        boolean updated;
    }
    Node[] tree;
    int n, count;
    public DynamicSegmentTreeArrayUpdate(int n, int m){
        this.n = n;
        this.count = 1;
        this.tree = new Node[m];
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, 1);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, 1);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, 1);
    }
    public void update(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
        update(l, r, x, 0, n - 1, 1);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, 1);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, 1);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, 1);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i].val += x; // å¢é‡æ›´æ–°
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, tree[i].lIdx);
        else add(idx, x, c + 1, t, tree[i].rIdx);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, int i){
        if(s == t) {
            tree[i].val = x; // è¦†ç›–æ›´æ–°
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, tree[i].lIdx);
        else update(idx, x, c + 1, t, tree[i].rIdx);
        pushUp(i);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹æŸ¥è¯¢ (å…·ä½“): æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int idx, int s, int t, int i){
        if(s == t) return tree[i].val;
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) return query(idx, s, c, tree[i].lIdx);
        else return query(idx, c + 1, t, tree[i].rIdx);
    }
    // åŒºé—´ä¿®æ”¹: è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
    private void update(int l, int r, int x, int s, int t, int i){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            tree[i].val = (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’Œç­‰äºt-s+1ä¸ªx
            if(s != t) {
                tree[i].lazy = x; // æ›´æ–°æ‡’æ ‡è®°
                tree[i].updated = true; // æ›´æ–°updated
            }
            return;
        }
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) update(l, r, x, s, c, tree[i].lIdx);
        if(r > c) update(l, r, x, c + 1, t, tree[i].rIdx);
        pushUp(i); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹å€¼
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, int i){
        if(l <= s && t <= r) return tree[i].val; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, sum = 0;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, tree[i].lIdx);
        if(r > c) sum += sum(l, r, c + 1, t, tree[i].rIdx);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, int i){
        if(s == t) return tree[i].val; // å¶å­ç»“ç‚¹
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, tree[i].lIdx);
        if(r > c) rmin = min(l, r, c + 1, t, tree[i].rIdx);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, int i){
        if(s == t) return tree[i].val;
        addNode(i); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(tree[i].updated) pushDown(s, c, t, i); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmax = max(l, r, s, c, tree[i].lIdx);
        if(r > c) rmax = max(l, r, c + 1, t, tree[i].rIdx);
        return Math.max(lmax, rmax);
    }
    // æ›´æ–° cur.val
    private void pushUp(int i){
        Node cur = tree[i], lChild = tree[cur.lIdx], rChild = tree[cur.rIdx];
        cur.val = lChild.val + rChild.val;
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°å’Œupdated
    private void pushDown(int s, int c, int t, int i){
        Node cur = tree[i], lChild = tree[cur.lIdx], rChild = tree[cur.rIdx];
        lChild.val = (c - s + 1) * cur.lazy; // æ›´æ–°å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lChild.lazy = cur.lazy; // ä¼ é€’æ‡’æ ‡è®°(å¢é‡æ ‡è®°)åˆ°å·¦å­ç»“ç‚¹ä¸­
        lChild.updated = true; // æ›´æ–°å·¦å­ç»“ç‚¹updated
        rChild.val = (t - c) * cur.lazy;
        rChild.lazy = cur.lazy;
        rChild.updated = true;
        cur.lazy = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼
        cur.updated = false; // æ›´æ–°updated
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(int i){
        if(tree[i] == null) tree[i] = new Node();
        if(tree[i].lIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å·¦å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].lIdx = ++count; // èµ‹äºˆç»“ç‚¹æ ‡å·
            tree[tree[i].lIdx] = new Node(); // å¼€è¾Ÿå®ä¾‹
        }
        if(tree[i].rIdx == 0) { // è‹¥ tree[i] ç»“ç‚¹æ— å³å­©å­ï¼Œæ·»åŠ ä¹‹
            tree[i].rIdx = ++count;
            tree[tree[i].rIdx] = new Node();
        }
    }
}
```

<br />

##### ç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•

###### å¢é‡å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘æŒ‡é’ˆç‰ˆ (å¸¦æ‡’æ ‡è®°ï¼Œå¢é‡å¼åŒºé—´ä¿®æ”¹)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æ±‚å’Œ / å¢é‡å¼åŒºé—´ä¿®æ”¹
 */
class DynamicSegmentTreePointerAdd{
    private class Node{
        int lazy, val;
        Node lChild, rChild;
    }
    int n;
    Node root;
    public DynamicSegmentTreePointerAdd(int n){
        this.n = n;
        this.root = new Node();
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, root);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, root);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, root);
    }
    public void add(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        add(l, r, x, 0, n - 1, root);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, root);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, root);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢ (é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, root);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, Node cur){
        if(s == t) {
            cur.val += x; // å¢é‡æ›´æ–°
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, cur.lChild);
        else add(idx, x, c + 1, t, cur.rChild);
        pushUp(cur); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, Node cur){
        if(s == t) {
            cur.val = x; // è¦†ç›–æ›´æ–°
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, cur.lChild);
        else update(idx, x, c + 1, t, cur.rChild);
        pushUp(cur);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹æŸ¥è¯¢: æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int i, int s, int t, Node cur){
        if(s == t) return cur.val;
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(i <= c) return query(i, s, c, cur.lChild);
        else return query(i, c + 1, t, cur.rChild);
    }
    // åŒºé—´ä¿®æ”¹: å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
    private void add(int l, int r, int x, int s, int t, Node cur){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            cur.val += (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’ŒåŠ ä¸Št-s+1ä¸ªx
            if(s != t) cur.lazy += x; // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹ï¼Œæ‡’æ ‡è®°å€¼åŠ ä¸Šx
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) add(l, r, x, s, c, cur.lChild);
        if(r > c) add(l, r, x, c + 1, t, cur.rChild);
        pushUp(cur); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, Node cur){
        if(l <= s && t <= r) return cur.val; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, sum = 0;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, cur.lChild);
        if(r > c) sum += sum(l, r, c + 1, t, cur.rChild);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, Node cur){
        if(s == t) return cur.val; // å¶å­ç»“ç‚¹
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(cur.lazy != 0) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, cur.lChild);
        if(r > c) rmin = min(l, r, c + 1, t, cur.rChild);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, Node cur){
        if(s == t) return cur.val;
        addNode(cur);
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(cur.lazy != 0) pushDown(s, c, t, cur);
        if(l <= c) lmax = max(l, r, s, c, cur.lChild);
        if(r > c) rmax = max(l, r, c + 1, t, cur.rChild);
        return Math.max(lmax, rmax);
    }
    // pushup: æ›´æ–° cur.val
    private void pushUp(Node cur){
        Node lChild = cur.lChild, rChild = cur.rChild;
        cur.val = lChild.val + rChild.val;
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°
    private void pushDown(int s, int c, int t, Node cur){
        Node lChild = cur.lChild, rChild = cur.rChild;
        lChild.val += (c - s + 1) * cur.lazy; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lChild.lazy += cur.lazy; // ä¼ é€’æ‡’æ ‡è®°
        rChild.val += (t - c) * cur.lazy;
        rChild.lazy += cur.lazy;
        cur.lazy = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(Node node){
        if(node.lChild == null) node.lChild = new Node();
        if(node.rChild == null) node.rChild = new Node();
    }
}
```

<br />

###### è¦†ç›–å¼åŒºé—´ä¿®æ”¹ç‰ˆ

```java
/**
 * åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘æŒ‡é’ˆç‰ˆ (å¸¦æ‡’æ ‡è®°ï¼Œè¦†ç›–å¼åŒºé—´ä¿®æ”¹)
 * æ”¯æŒï¼šå•ç‚¹ä¿®æ”¹ / å•ç‚¹æŸ¥è¯¢ / åŒºé—´æŸ¥è¯¢ / è¦†ç›–å¼åŒºé—´ä¿®æ”¹
 */
class DynamicSegmentTreePointerUpdate{
    private class Node{
        int lazy, val;
        boolean updated;
        Node lChild, rChild;
    }
    int n;
    Node root;
    public DynamicSegmentTreePointerUpdate(int n){
        this.n = n;
        this.root = new Node();
    }
    public void add(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ nums[i] += x
        add(i, x, 0, n - 1, root);
    }
    public void update(int i, int x){ // å•ç‚¹ä¿®æ”¹(é©±åŠ¨): è¦†ç›–å¼ nums[i] = x
        update(i, x, 0, n - 1, root);
    }
    public int query(int i){ // å•ç‚¹æŸ¥è¯¢(é©±åŠ¨): æŸ¥è¯¢ nums[i]
        return query(i, 0, n - 1, root);
    }
    public void update(int l, int r, int x){ // åŒºé—´ä¿®æ”¹(é©±åŠ¨): å¢é‡å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ åŠ ä¸Šx
        update(l, r, x, 0, n - 1, root);
    }
    public int sum(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): nums[l]~nums[r]ä¹‹å’Œ
        return sum(l, r, 0, n - 1, root);
    }
    public int min(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
        return min(l, r, 0, n - 1, root);
    }
    public int max(int l, int r){ // åŒºé—´æŸ¥è¯¢(é©±åŠ¨): æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
        return max(l, r, 0, n - 1, root);
    }
    // å•ç‚¹ä¿®æ”¹: å¢é‡å¼ ä»¤nums[idx] += xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void add(int idx, int x, int s, int t, Node cur){
        if(s == t) {
            cur.val += x; // å¢é‡æ›´æ–°
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) add(idx, x, s, c, cur.lChild);
        else add(idx, x, c + 1, t, cur.rChild);
        pushUp(cur); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹ä¿®æ”¹: è¦†ç›–å¼ ä»¤nums[idx] = xã€‚ä¿®æ”¹å¶å­ç»“ç‚¹ï¼Œæ— å…³æ ‡è®°ã€‚
    private void update(int idx, int x, int s, int t, Node cur){
        if(s == t) {
            cur.val = x; // è¦†ç›–æ›´æ–°
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(idx <= c) update(idx, x, s, c, cur.lChild);
        else update(idx, x, c + 1, t, cur.rChild);
        pushUp(cur);  // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // å•ç‚¹æŸ¥è¯¢: æŸ¥è¯¢ nums[i]ï¼Œå°¾é€’å½’
    private int query(int i, int s, int t, Node cur){
        if(s == t) return cur.val;
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(i <= c) return query(i, s, c, cur.lChild);
        else return query(i, c + 1, t, cur.rChild);
    }
    // åŒºé—´ä¿®æ”¹: è¦†ç›–å¼ [l,r] åŒºé—´æ‰€æœ‰å…ƒç´ æ”¹ä¸ºx
    private void update(int l, int r, int x, int s, int t, Node cur){
        if(l <= s && t <= r){ // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
            cur.val = (t - s + 1) * x; // ç»“ç‚¹içš„åŒºé—´å’Œç­‰äºt-s+1ä¸ªx
            if(s != t) { // ç»“ç‚¹iä¸æ˜¯å¶å­ç»“ç‚¹
                cur.lazy = x; // æ›´æ–°æ‡’æ ‡è®°
                cur.updated = true; // æ›´æ–°updated
            }
            return;
        }
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) update(l, r, x, s, c, cur.lChild);
        if(r > c) update(l, r, x, c + 1, t, cur.rChild);
        pushUp(cur); // ååºåŠ¨ä½œï¼Œè‡ªåº•å‘ä¸Šæ›´æ–°ç»“ç‚¹åŒºé—´å’Œ tree[i]
    }
    // åŒºé—´æŸ¥è¯¢: æ±‚ nums[l]~nums[r]ä¹‹å’Œ
    private int sum(int l, int r, int s, int t, Node cur){
        if(l <= s && t <= r) return cur.val; // å½“å‰ç»“ç‚¹ä»£è¡¨çš„åŒºé—´åœ¨æ‰€æ±‚åŒºé—´ä¹‹å†…
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, sum = 0;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) sum += sum(l, r, s, c, cur.lChild);
        if(r > c) sum += sum(l, r, c + 1, t, cur.rChild);
        return sum;
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å°å€¼
    private int min(int l, int r, int s, int t, Node cur){
        if(s == t) return cur.val; // å¶å­ç»“ç‚¹
        addNode(cur); // åŠ¨æ€å¼€ç‚¹
        int c = s + (t - s) / 2, lmin = Integer.MAX_VALUE, rmin = Integer.MAX_VALUE;
        if(cur.updated) pushDown(s, c, t, cur); // æ˜¯å¦æ¨é€æ ‡è®°
        if(l <= c) lmin = min(l, r, s, c, cur.lChild);
        if(r > c) rmin = min(l, r, c + 1, t, cur.rChild);
        return Math.min(lmin, rmin);
    }
    // åŒºé—´æŸ¥è¯¢: æŸ¥è¯¢[l,r]ä¸­çš„æœ€å¤§å€¼
    private int max(int l, int r, int s, int t, Node cur){
        if(s == t) return cur.val;
        addNode(cur);
        int c = s + (t - s) / 2, lmax = Integer.MIN_VALUE, rmax = Integer.MIN_VALUE;
        if(cur.updated) pushDown(s, c, t, cur);
        if(l <= c) lmax = max(l, r, s, c, cur.lChild);
        if(r > c) rmax = max(l, r, c + 1, t, cur.rChild);
        return Math.max(lmax, rmax);
    }
    // pushup: æ›´æ–° cur.val
    private void pushUp(Node cur){
        Node lChild = cur.lChild, rChild = cur.rChild;
        cur.val = lChild.val + rChild.val;
    }
    // pushdown: æ›´æ–°å½“å‰ç»“ç‚¹åŠå…¶å·¦å³å­ç»“ç‚¹çš„æ‡’æ ‡è®°å’Œupdated
    private void pushDown(int s, int c, int t, Node cur){
        Node lChild = cur.lChild, rChild = cur.rChild;
        lChild.val = (c - s + 1) * cur.lazy; // æ›´æ–°å…¶å·¦å­ç»“ç‚¹çš„åŒºé—´å’Œ
        lChild.lazy = cur.lazy; // ä¼ é€’æ‡’æ ‡è®°(å¢é‡æ ‡è®°)
        lChild.updated = true;
        rChild.val = (t - c) * cur.lazy;
        rChild.lazy = cur.lazy;
        rChild.updated = true;
        cur.lazy = 0; // é‡ç½®å½“å‰ç»“ç‚¹æ‡’æƒ°æ ‡è®°å€¼ï¼ˆå¢é‡æ ‡è®°ç½®0ï¼‰
        cur.updated = false;
    }
    // åŠ¨æ€å¼€ç‚¹
    private void addNode(Node node){
        if(node.lChild == null) node.lChild = new Node();
        if(node.rChild == null) node.rChild = new Node();
    }
}
```

<br />

### æ€»ç»“

æœ¬æ–‡ä»åŸºæœ¬çš„é™æ€çº¿æ®µæ ‘åˆ°åŠ¨æ€çº¿æ®µæ ‘ï¼Œä»‹ç»äº†å¦‚ä¸‹å†…å®¹ã€‚

- **åŸºæœ¬åŸç†ï¼š** é€šè¿‡ **ã€Œå®Œå…¨äºŒå‰æ ‘ä¸‹æ ‡æ€§è´¨ã€** å’Œ **ã€Œåˆ†æ²»ç®—æ³•ã€** æ¥ç†è§£åŸºæœ¬çº¿æ®µæ ‘çš„å·¥ä½œåŸç†ã€‚
- **åŸºæœ¬ (é™æ€) çº¿æ®µæ ‘ï¼š** é¦–å…ˆå®ç°äº†æ”¯æŒã€Œå•ç‚¹ä¿®æ”¹ã€å’Œã€ŒåŒºé—´æŸ¥è¯¢ã€çš„åŸºæœ¬çº¿æ®µæ ‘ï¼Œå¯è§£å†³ [307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/) ã€‚
- **æ‡’æƒ°æ ‡è®°ï¼š** å¼•å…¥ **ã€Œæ‡’æƒ°æ ‡è®°ã€** å’Œ **ã€Œå»¶è¿Ÿä¿®æ”¹ã€** çš„æ¦‚å¿µï¼Œç”¨ä»¥å®ç° $O(logn)$ æ—¶é—´å¤æ‚åº¦çš„ ã€ŒåŒºé—´ä¿®æ”¹ã€ã€‚
- **ç¦»æ•£åŒ–ï¼š** å½“åŒºé—´é—®é¢˜ä¸åŒºé—´å…ƒç´ çš„ç»å¯¹ä½ç½®æ— å…³è€Œåªä¸å®ƒä»¬çš„ç›¸å¯¹ä½ç½®æœ‰å…³æ—¶ï¼Œå¯ä»¥é‡‡ç”¨ **ã€Œç¦»æ•£åŒ–ã€** å‹ç¼©åŒºé—´èŒƒå›´ï¼Œå…¸å‹é¢˜ç›®å¦‚ [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) ã€‚å…·ä½“çš„ç¦»æ•£åŒ–æ–¹æ³•åŒ…æ‹¬ **ã€Œç´§ç¦»æ•£ã€** å’Œ **ã€Œæ¾ç¦»æ•£ã€** ã€‚
- **åŠ¨æ€å¼€ç‚¹ï¼š** å½“åŒºé—´é—®é¢˜å…·æœ‰ã€Œ[å¼ºåˆ¶åœ¨çº¿](https://en.wikipedia.org/wiki/Online_algorithm)ã€çš„ç‰¹ç‚¹æ—¶ï¼Œç”±äºæ— æ³•ç¦»æ•£åŒ–ï¼Œè¿«ä½¿æˆ‘ä»¬æ€è€ƒèƒ½å¦å®ç° **ã€ŒåŠ¨æ€å¼€ç‚¹ã€**  (åŠ¨æ€åœ°åˆ›å»ºç»“ç‚¹) çš„çº¿æ®µæ ‘ã€‚å…¸å‹é¢˜ç›®å¦‚ [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) ã€‚
  - **æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ï¼š** è‹¥èƒ½æå‰ä¼°è®¡æ ‘çš„å¤§å°ï¼Œå¯ç”¨  **ã€Œç»“ç‚¹æ•°ç»„æ³•ã€** å®ç°åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ã€‚ç»™å‡ºç»“ç‚¹æ•°ä¼°è®¡æ–¹æ³•ã€‚
    - **ç»“ç‚¹æ•°ä¼°è®¡**: åœ¨å·²çŸ¥æ“ä½œæ¬¡æ•°ä¸Šé™çš„æƒ…å†µä¸‹å¯ä»¥é¢„ä¼°ç»“ç‚¹æ•°ï¼Œä»¥ä¾¿äºåˆå§‹åŒ–ã€Œç»“ç‚¹æ•°ç»„ã€ã€‚

  - **æŒ‡é’ˆæ³•åŠ¨æ€çº¿æ®µæ ‘ï¼š** é€šè¿‡ **ã€Œç»“ç‚¹æŒ‡é’ˆ (å¼•ç”¨) æ³•ã€** å®ç°çš„åŠ¨æ€å¼€ç‚¹çº¿æ®µæ ‘ï¼Œæ— éœ€é¢„ä¼°æ ‘çš„å¤§å°ã€‚




æ–‡ä¸­æˆ‘ä»¬ç»™å‡ºäº†å¦‚ä¸‹åç§çº¿æ®µæ ‘çš„å®Œæ•´çš„ç±»ä»£ç ã€‚

| çº¿æ®µæ ‘ç±»                             | æè¿°                                                         |
| ------------------------------------ | ------------------------------------------------------------ |
| 1. $SegmentTreeBasic1$               | åŸºæœ¬é™æ€çº¿æ®µæ ‘ï¼Œä¸å¸¦æ‡’æƒ°æ ‡è®°ï¼Œåªæ”¯æŒå•ç‚¹ä¿®æ”¹å’ŒåŒºé—´æŸ¥è¯¢ï¼Œå®æ—¶ç»´æŠ¤ $nums$ |
| 2. $SegmentTreeBasic2$               | åŸºæœ¬é™æ€çº¿æ®µæ ‘ï¼Œä¸å¸¦æ‡’æƒ°æ ‡è®°ï¼Œåªæ”¯æŒå•ç‚¹ä¿®æ”¹å’ŒåŒºé—´æŸ¥è¯¢ï¼Œä¸ç»´æŠ¤ $nums$ |
| 3. $SegmentTreeAdd$                  | é™æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/å¢é‡å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 4. $SegmentTreeUpdate$               | é™æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/è¦†ç›–å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 5. $DynamicSegmentTreeArrayAdd$      | ç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/å¢é‡å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 6. $DynamicSegmentTreeArrayUpdate$   | ç»“ç‚¹æ•°ç»„æ³•åŠ¨æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/è¦†ç›–å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 7. $DynamicSegmentTreePointerAdd$    | ç»“ç‚¹æŒ‡é’ˆæ³•åŠ¨æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/å¢é‡å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 8. $DynamicSegmentTreePointerUpdate$ | ç»“ç‚¹æŒ‡é’ˆæ³•åŠ¨æ€çº¿æ®µæ ‘ï¼Œå¸¦æ‡’æƒ°æ ‡è®°ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/è¦†ç›–å¼åŒºé—´ä¿®æ”¹/åŒºé—´æŸ¥è¯¢ |
| 9. $SegmentTreeBasicRangeMax$        | åŒºé—´æœ€å¤§å€¼åŸºæœ¬é™æ€çº¿æ®µæ ‘ï¼Œæ— æ‡’æ ‡è®°ï¼Œä¸ç»´æŠ¤ $nums[i]$ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/åŒºé—´æŸ¥è¯¢ |
| 10. $SegmentTreeBasic$               | æ‰©å±•åŒºé—´æŸ¥è¯¢åŸºæœ¬é™æ€çº¿æ®µæ ‘ï¼Œæ— æ‡’æ ‡è®°ï¼Œä¸ç»´æŠ¤ $nums[i]$ï¼Œæ”¯æŒå•ç‚¹ä¿®æ”¹/å•ç‚¹æŸ¥è¯¢/åŒºé—´æŸ¥è¯¢ |

æ³¨æ„ï¼Œ1~8 çš„å®ç°ä¸­ï¼Œ$tree[]$ è®°å½•çš„æ˜¯ã€ŒåŒºé—´å’Œã€ï¼Œ9è®°å½•çš„ã€Œæœ€å¤§å€¼ã€ï¼Œ10ä»¥ä¸‰ä¸ªçº¿æ®µæ ‘æ•°ç»„åŒæ—¶è®°å½•ã€ŒåŒºé—´å’Œã€ã€ã€ŒåŒºé—´æœ€å¤§å€¼ã€ä»¥åŠã€ŒåŒºé—´æœ€å°å€¼ã€ã€‚æ€»ä¹‹ï¼Œå°† 1~8 ä¸­çš„ $tree[]$ ç”¨äºè®°å½•ã€ŒåŒºé—´æœ€å€¼ã€ï¼Œç»è¿‡æˆ‘ä»¬åœ¨ã€ŒåŒºé—´æœ€å€¼æŸ¥è¯¢ã€å°èŠ‚ä¸­çš„è°ƒæ•´ï¼Œå³å¯å¾—åˆ°ç›¸åº”çš„ä»¥ $O(logn)$ æ—¶é—´å¤æ‚åº¦å®ç°åŒºé—´æœ€å€¼æŸ¥è¯¢çš„çº¿æ®µæ ‘ç‰ˆæœ¬ã€‚



çº¿æ®µæ ‘çš„åº”ç”¨æ˜¯ååˆ†çµæ´»è€Œå¼ºå¤§çš„ï¼Œæœ¬æ–‡åªè®²è§£äº†ä½œè€…æ‰€çŸ¥çš„æœ€åŸºæœ¬çš„ä¸€äº›å†…å®¹ï¼Œæ›´å¤šçš„åº”ç”¨å·²ç„¶è¶…å‡ºäº†ä½œè€…çš„æ°´å¹³ã€‚å¥½åœ¨è¿™äº›å†…å®¹å·²åŸºæœ¬è¶³å¤Ÿæ±‚è§£åŠ›æ‰£ä¸Šå‡ ä¹æ‰€æœ‰çº¿æ®µæ ‘é¢˜ç›®ã€‚

â€» æ¨èæ¸…åå¤§å­¦å¼ æ˜†ç®å†™çš„ä¸€ä»½ 101 é¡µçš„ ppt ææ–™ [ç»Ÿè®¡çš„åŠ›é‡ â€”â€” çº¿æ®µæ ‘å…¨æ¥è§¦](https://github.com/tiankonguse/lab/blob/master/acm/paper/%E7%BB%9F%E8%AE%A1%E7%9A%84%E5%8A%9B%E9%87%8F%E2%80%94%E2%80%94%E7%BA%BF%E6%AE%B5%E6%A0%91%E8%AF%A6%E7%BB%86%E6%95%99%E7%A8%8B.pdf) ï¼Œå¯ä½œä¸ºçº¿æ®µæ ‘åº”ç”¨çš„æ€»è§ˆææ–™ã€‚

<br />

### å®æˆ˜åº”ç”¨

| é¢˜ç›®                                                         | éš¾åº¦ | é¢˜è§£                                                         |
| ------------------------------------------------------------ | ---- | ------------------------------------------------------------ |
| [307. åŒºåŸŸå’Œæ£€ç´¢ - æ•°ç»„å¯ä¿®æ”¹](https://leetcode.cn/problems/range-sum-query-mutable/) | ä¸­ç­‰ | [é¢˜è§£](https://leetcode.cn/problems/range-sum-query-mutable/solution/yukiyama-by-yukiyama-euo5/) |
| [699. æ‰è½çš„æ–¹å—](https://leetcode.cn/problems/falling-squares/) | å›°éš¾ | [é¢˜è§£](https://leetcode.cn/problems/falling-squares/solution/-by-yukiyama-lxtu/) |
| [715. Range æ¨¡å—](https://leetcode.cn/problems/range-module/) | å›°éš¾ | [é¢˜è§£](https://leetcode.cn/problems/range-module/solution/yukiyama-by-yukiyama-lyg5/) |
| [218. å¤©é™…çº¿é—®é¢˜](https://leetcode.cn/problems/the-skyline-problem/) | å›°éš¾ | [é¢˜è§£](https://leetcode.cn/problems/the-skyline-problem/solution/by-yukiyama-l4rc/) |
| [729. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ I](https://leetcode.cn/problems/my-calendar-i/) | ä¸­ç­‰ | [é¢˜è§£](https://leetcode.cn/problems/my-calendar-i/solution/by-yukiyama-kddx/) |
| [731. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ II](https://leetcode.cn/problems/my-calendar-ii/) | ä¸­ç­‰ | [é¢˜è§£](https://leetcode.cn/problems/my-calendar-ii/solution/yukiyama-by-yukiyama-uuvj/) |
| [732. æˆ‘çš„æ—¥ç¨‹å®‰æ’è¡¨ III](https://leetcode.cn/problems/my-calendar-iii/) | å›°éš¾ | [é¢˜è§£](https://leetcode.cn/problems/my-calendar-iii/solution/by-yukiyama-7zz5/) |
| [253. ä¼šè®®å®¤ II](https://leetcode.cn/problems/meeting-rooms-ii/) | ä¸­ç­‰ | [é¢˜è§£](https://leetcode.cn/problems/meeting-rooms-ii/solution/yukiyama-by-yukiyama-9cml/) |
| [2407. æœ€é•¿é€’å¢å­åºåˆ— II](https://leetcode.cn/problems/longest-increasing-subsequence-ii/) | å›°éš¾ | [é¢˜è§£](https://leetcode.cn/problems/longest-increasing-subsequence-ii/solution/-by-yukiyama-khmm/) |
| ==== æ›´å¤šé¢˜ç›®è¿½åŠ ä¸­ ====                                     |      |                                                              |

<br />

***

**æ–‡ç« æ›´æ–°æ—¥å¿—**

[2022-09-18]

- å¢åŠ äº†å°‘é‡å†…å®¹ï¼Œè¯´æ˜ $tree[]$ ä»£è¡¨ã€ŒåŒºé—´å’Œã€å’Œã€ŒåŒºé—´æœ€å€¼ã€æ—¶ï¼Œæ±‚æœ€å€¼çš„æ–¹æ³• ($max$ , $min$) çš„æ—¶é—´å¤æ‚åº¦çš„åŒºåˆ«ã€‚å³å½“ $tree[]$ ä»£è¡¨ã€ŒåŒºé—´å’Œã€æ—¶ï¼Œæ±‚æœ€å€¼çš„æ–¹æ³•çš„æ—¶é—´å¤æ‚åº¦ä¸º $O(n)$ ï¼Œä»£è¡¨ã€ŒåŒºé—´æœ€å€¼ã€æ—¶ï¼Œä¸º $O(logn)$ ã€‚

[2022-08-03]

- åœ¨ã€Œå®æˆ˜åº”ç”¨ã€ä¸­å¢åŠ  [253. ä¼šè®®å®¤ II](https://leetcode.cn/problems/meeting-rooms-ii/) çš„ [é¢˜è§£](https://leetcode.cn/problems/meeting-rooms-ii/solution/yukiyama-by-yukiyama-9cml/) ã€‚

***

